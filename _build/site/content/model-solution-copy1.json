{"version":3,"kind":"Notebook","sha256":"e0d190059943fcbfebb48ea47b500ab53874526a23d9c2e9a5e19915e8afb84f","slug":"model-solution-copy1","location":"/Model_solution-Copy1.ipynb","dependencies":[],"frontmatter":{"kernelspec":{"name":"roms-tools","display_name":"Python (My roms-tools Kernel)","language":"python"},"exports":[{"format":"ipynb","filename":"Model_solution-Copy1.ipynb","url":"/Model_solution-Copy1-27c97114c36c304ace5b52964dc06e6e.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import subprocess\nimport os\nimport pandas as pd\nimport netCDF4\nimport numpy as np\nimport glob\nimport time\nimport matplotlib.pyplot as plt\nimport copy\nimport xarray as xr\nfrom datetime import datetime, timedelta \nimport dask\nfrom scipy.interpolate import griddata\n#from ocean_c_lab_tools import *\n#from celluloid import Camera \n#import PyCO2SYS as csys\nimport seawater as sw\nfrom roms_regrid import *","key":"PVxSi57Cp5"},{"type":"outputs","id":"TU0c4zBRP17Pq57G2KAn1","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/tmp/ipykernel_4091772/3005166470.py:17: UserWarning: The seawater library is deprecated! Please use gsw instead.\n  import seawater as sw\n"},"children":[],"key":"jS87JkMBBy"}],"key":"PsCpG8bmvm"}],"key":"r19lXJyfr7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"HAFRO_path='/home/x-uheede/R/HAFRO/Hafro_cruises.xls'\nmodel_grid_path=\"/home/x-uheede/S/Iceland2_MARBL_2024_60m/P_INPUT/Iceland2_grid_MAT1.nc\"\n# Grid parameters, only modify these if grid is made in MATLAB\nvert_levels=60\ntheta_s_model=5\ntheta_b_model=2\nhc_model=300\nmodel_data_path=\"/anvil/scratch/x-uheede/Iceland2_NOMARBL_2024_NewV/Iceland2_MARBL_2024_his.20240[4][0-14]???????.nc\"\nmonths_analysis=[4] # enter the months you want to analyze for the model\n# enter the dates you want to analyze for the observations\ntarget_depth_levels=[10] # Specify depth levels of interest\nthinner=1 # specify the temporal frequency of data being read (i.e. no need to read in hourly data)\n","key":"EhzF9U7JRo"},{"type":"outputs","id":"bEjge0DQEgYlUgG3CvlfV","children":[],"key":"ivGfhREcUr"}],"key":"aP6JWJkDMX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, ROMSOutput\ngrid = Grid.from_file(\n    model_grid_path\n)\n","key":"mh2wBfvw4B"},{"type":"outputs","id":"qsRJV0HcsqXRnREqbVFMY","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-12-08 14:14:17 - WARNING - Vertical coordinates (Cs_r, Cs_w) not found in grid file.\n2025-12-08 14:14:17 - INFO - === Preparing the vertical coordinate system using N = 100, theta_s = 5.0, theta_b = 2.0, hc = 300.0 ===\n2025-12-08 14:14:17 - INFO - Total time: 0.004 seconds\n2025-12-08 14:14:17 - INFO - ========================================================================================================\n"},"children":[],"key":"s6SmP8b2mu"}],"key":"NdMN105Nrh"}],"key":"yI1MdRuGpB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#Only run this cell if grid is made in MATLAB\ngrid.update_vertical_coordinate(N=vert_levels, theta_s=theta_s_model, theta_b=theta_b_model, hc=hc_model, verbose=False)","key":"IEEOUzzvSL"},{"type":"outputs","id":"zFqi2cRdXg91V358xVAko","children":[],"key":"YOL4rotbEV"}],"key":"nKCIxVQ4kl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import xarray as xr\nimport numpy as np\ntarget_depth_levels=[1,2,3,4,5,7,9,10,12,14,15,16,18,20,26,30,36,40,50,80] # Specify depth levels of interest\n# Load ROMS output using your pattern\nroms_output = ROMSOutput(\n    grid=grid,\n    path=[\n        model_data_path,\n    ],\n    use_dask=True,\n)\n\nds = roms_output.regrid(var_names=[\"u\", \"v\"],depth_levels=target_depth_levels)","key":"xKdhpFHkdB"},{"type":"outputs","id":"CAzYePP5t5EyyeLrFOwJ_","children":[],"key":"cwYN2rNx0c"}],"key":"w3188GVAaf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"u_rg=ds['u'].mean('time').load()\nv_rg=ds['v'].mean('time').load()","key":"UZMFFNCcq0"},{"type":"outputs","id":"EBYVF71Hs1bTpH7HKE3zi","children":[],"key":"mmS4n3IB9s"}],"key":"RPhoGwhUar"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import cartopy.crs as ccrs\nimport cartopy.mpl.ticker as cticker\nimport matplotlib.pyplot as plt\nimport numpy as np\n\n# -------------------------------------------------------\n#  Select depths and prepare surface/20 m vector plotting\n# -------------------------------------------------------\nsurface_depth = 0\ndepth20 = 20\n\nu_surf = u_rg.sel(depth=surface_depth, method=\"nearest\")\nv_surf = v_rg.sel(depth=surface_depth, method=\"nearest\")\n\nu_20 = u_rg.sel(depth=depth20, method=\"nearest\")\nv_20 = v_rg.sel(depth=depth20, method=\"nearest\")\n\nlon = u_rg.lon\nlat = u_rg.lat\n\n# -------------------------------------------------------\n# 1) Compute full-resolution land mask (before thinning)\n# -------------------------------------------------------\nmask_surf_full = np.isnan(u_surf) | np.isnan(v_surf)\nmask_200_full  = np.isnan(u_20)   | np.isnan(v_20)\n\n# -------------------------------------------------------\n# 2) Thin vectors\n# -------------------------------------------------------\nstep = 4\nlon_thin = lon[::step]\nlat_thin = lat[::step]\n\nu_surf_thin = u_surf[::step, ::step]\nv_surf_thin = v_surf[::step, ::step]\n\nu_200_thin = u_20[::step, ::step]\nv_200_thin = v_20[::step, ::step]\n\n# -------------------------------------------------------\n#  Data for vertical sections\n# -------------------------------------------------------\nlonA = 360 - 21.85\nlonB = 360 - 21.55\n\nuA = u_rg.sel(lon=lonA, method=\"nearest\")\nif \"time\" in uA.dims:\n    uA = uA.isel(time=0)\nuA = uA.transpose(\"depth\", \"lat\")\n\nuB = u_rg.sel(lon=lonB, method=\"nearest\")\nif \"time\" in uB.dims:\n    uB = uB.isel(time=0)\nuB = uB.transpose(\"depth\", \"lat\")\n\ndepth_vals = uA.depth.values\nlat_vals_A = uA.lat.values\nlat_vals_B = uB.lat.values\n\nextent_hval = [-22.2543190362897, -21.3469394652069, \n               64.25114671, 64.45802068]\n\n# -------------------------------------------------------\n# Plotting using GridSpec\n# -------------------------------------------------------\nfig = plt.figure(figsize=(14, 10))\ngs = fig.add_gridspec(2, 2, height_ratios=[1, 1])\n\n# ===========================\n# Panel 1 — Surface vectors\n# ===========================\nax1 = fig.add_subplot(gs[0, 0], projection=ccrs.PlateCarree())\nax1.set_extent(extent_hval)\n\n# Mask\nax1.contourf(\n    lon, lat, mask_surf_full,\n    levels=[0.5, 1.5],\n    colors=[\"lightgray\"],\n    transform=ccrs.PlateCarree(),\n    zorder=1\n)\n\n# Vectors\nax1.quiver(\n    lon_thin, lat_thin,\n    u_surf_thin, v_surf_thin,\n    transform=ccrs.PlateCarree(), zorder=2\n)\n\n# --- NEW: vertical slice lines ---\nax1.plot([lonA-360, lonA-360], [lat.min(), lat.max()], \n         color='black',alpha=0.6, linewidth=2, transform=ccrs.PlateCarree())\nax1.plot([lonB-360, lonB-360], [lat.min(), lat.max()], \n         color='black',alpha=0.6, linewidth=2, transform=ccrs.PlateCarree())\n\nax1.set_title(\"Surface velocity vectors (thinned)\")\nax1.set_xticks([-22.2, -22.0, -21.8, -21.6, -21.4], crs=ccrs.PlateCarree())\nax1.set_yticks([64.26, 64.30, 64.34, 64.38, 64.42], crs=ccrs.PlateCarree())\nax1.xaxis.set_major_formatter(cticker.LongitudeFormatter())\nax1.yaxis.set_major_formatter(cticker.LatitudeFormatter())\nax1.set_xlabel(\"Longitude\")\nax1.set_ylabel(\"Latitude\")\n\n# ===========================\n# Panel 2 — 20 m vectors\n# ===========================\nax2 = fig.add_subplot(gs[0, 1], projection=ccrs.PlateCarree())\nax2.set_extent(extent_hval)\n\n# Mask\nax2.contourf(\n    lon, lat, mask_200_full,\n    levels=[0.5, 1.5],\n    colors=[\"lightgray\"],\n    transform=ccrs.PlateCarree(),\n    zorder=1\n)\n\n# Vectors\nax2.quiver(\n    lon_thin, lat_thin,\n    u_200_thin, v_200_thin,\n    color=\"red\",\n    transform=ccrs.PlateCarree(),\n    zorder=2\n)\n\n# --- NEW: vertical slice lines ---\n#ax2.plot([lonA-360, lonA-360], [lat.min(), lat.max()],\n#         color='yellow', linewidth=2, transform=ccrs.PlateCarree())\n#ax2.plot([lonB-360, lonB-360], [lat.min(), lat.max()],\n#         color='yellow', linewidth=2, transform=ccrs.PlateCarree())\n\nax2.set_title(\"20 m velocity vectors (thinned)\")\nax2.set_xticks([-22.2, -22.0, -21.8, -21.6, -21.4], crs=ccrs.PlateCarree())\nax2.set_yticks([64.26, 64.30, 64.34, 64.38, 64.42], crs=ccrs.PlateCarree())\nax2.xaxis.set_major_formatter(cticker.LongitudeFormatter())\nax2.yaxis.set_major_formatter(cticker.LatitudeFormatter())\nax2.set_xlabel(\"Longitude\")\nax2.set_ylabel(\"Latitude\")\n\n# ===========================\n# Panel 3 — Vertical section at A\n# ===========================\nax3 = fig.add_subplot(gs[1, 0])\ncf = ax3.contourf(lat_vals_A, depth_vals, uA, levels=30,cmap='RdBu')\nax3.set_title(f\"Zonal velocity u(z, lat) at {lonA-360:.2f}°E\")\nax3.set_xlabel(\"Latitude\")\nax3.set_ylabel(\"Depth (m)\")\nfig.colorbar(cf, ax=ax3, label=\"u (m/s)\")\n\nax3.set_ylim(0, 40)\nax3.invert_yaxis()\nax3.set_xlim(64.26, 64.32)\n\n# ===========================\n# Panel 4 — Vertical section at B\n# ===========================\nax4 = fig.add_subplot(gs[1, 1])\ncf = ax4.contourf(lat_vals_B, depth_vals, uB, levels=30, cmap='RdBu')\nax4.set_title(f\"Zonal velocity u(z, lat) at {lonB-360:.2f}°E\")\nax4.set_xlabel(\"Latitude\")\nax4.set_ylabel(\"Depth (m)\")\nfig.colorbar(cf, ax=ax4, label=\"u (m/s)\")\n\nax4.set_ylim(0, 40)\nax4.invert_yaxis()\nax4.set_xlim(64.375, 64.39)\n\nplt.tight_layout()\nplt.show()\n","key":"gj3ijAGt2t"},{"type":"outputs","id":"Xn2HnLG9CWMkg_PukDuMR","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"1f62d05498df748009494e8546fe1b89","path":"/1f62d05498df748009494e8546fe1b89.png"},"text/plain":{"content":"<Figure size 1400x1000 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"an9EnXsuUR"}],"key":"lU6s4Y1l6e"}],"key":"oo8anMvknk"}],"key":"Hg3gLHiteI"},"references":{"cite":{"order":[],"data":{}}}}