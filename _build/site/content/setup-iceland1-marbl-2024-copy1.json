{"version":3,"kind":"Notebook","sha256":"264fb7f14f77e5e170acb6c5b3021b8cadc156af5c40eb39c5631607b6e812c8","slug":"setup-iceland1-marbl-2024-copy1","location":"/SETUP_Iceland1_MARBL_2024-Copy1.ipynb","dependencies":[],"frontmatter":{"title":"ROMS-TOOLS setup for Iceland1_MARBL_2024","content_includes_title":false,"kernelspec":{"name":"roms-tools","display_name":"Python (My roms-tools Kernel)","language":"python"},"exports":[{"format":"ipynb","filename":"SETUP_Iceland1_MARBL_2024-Copy1.ipynb","url":"/SETUP_Iceland1_MARBL-a286367c3b68a5c64f6116ab2a5d060b.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"First step is to set up the outer grid using ROMS-TOOLS and save the grid file.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MGU0wlPW53"}],"key":"bXK8FJiORY"}],"key":"GMVFHKmPvh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid","key":"w669UPqo2g"},{"type":"outputs","id":"mWqmtSfv9Gud0gR0FifGf","children":[],"key":"U20iddZH7C"}],"key":"S1c2wmYUEd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"project='/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/'\ndatasets='/anvil/projects/x-ees250129/Datasets_subset/'\nmodel_name='Iceland1'\nchild_name='Iceland2'\ngrid_path='/anvil/projects/x-ees250129/x-uheede/MATLAB/setup_r2r_phys+bgc/1.Make_grid/Iceland1_grid_MAT1.nc'","key":"vQbgG3jMgL"},{"type":"outputs","id":"TMXm9fdA9e9Hhd4GEyeP1","children":[],"key":"mMWJnLGxFN"}],"key":"gGre1Z0Wmg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=512,\n#    size_x=384,\n#    size_y=384,\n#    center_lon=-24,\n#    center_lat=64.9,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"bh9aFyaq2W"},{"type":"outputs","id":"MGVCw_tU0JmpeA2kZFxdw","children":[],"key":"sZ6Xk0Rrls"}],"key":"QWMNNVz2pG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=384,\n#    size_x=384,\n#    size_y=288,\n#    center_lon=-22.6,\n#    center_lat=63.55,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"MeAnrndfQa"},{"type":"outputs","id":"6ICBbZ6GIY2Q8N_4w7ClY","children":[],"key":"PrOj1ceCM3"}],"key":"D1W2k8xpNK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid = Grid.from_file(grid_path)","key":"Bcg5oZ0opn"},{"type":"outputs","id":"-QpcC5z3k9YodIxEAlprX","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-11-18 18:34:40 - WARNING - Vertical coordinates (Cs_r, Cs_w) not found in grid file.\n2025-11-18 18:34:40 - INFO - === Preparing the vertical coordinate system using N = 100, theta_s = 5.0, theta_b = 2.0, hc = 300.0 ===\n2025-11-18 18:34:40 - INFO - Total time: 0.003 seconds\n2025-11-18 18:34:40 - INFO - ========================================================================================================\n"},"children":[],"key":"hSlLXjRiLL"}],"key":"JRoyqFozc3"}],"key":"rXRWm0eFJO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.update_vertical_coordinate(N=60, theta_s=5.0, theta_b=2.0, hc=300.0, verbose=False)","key":"tC8mHQDbYt"},{"type":"outputs","id":"ruhxYRjBfnTYAEnVuFn3N","children":[],"key":"FPdm6XLDYb"}],"key":"ChrjPVcNwK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.plot()","key":"pS03SccDER"},{"type":"outputs","id":"UysNKxUL1pu_gX7oiZ3hS","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"70240b2ddedc41c2506ea18b24900928","path":"/70240b2ddedc41c2506ea18b24900928.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"po4IRhHzSc"}],"key":"I7zAqTT65T"}],"key":"TB6bicF5kC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+'_grid.nc'\nyaml_filepath=project+model_name+'_grid_60.yaml'","key":"WqRfsQl9vd"},{"type":"outputs","id":"0ou8zwGhjCQcmLZiOGJKE","children":[],"key":"lA9R5MXEjb"}],"key":"M3fO7A3NcG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"yaml_filepath","key":"PTZfNJoPnZ"},{"type":"outputs","id":"uAPE_NKs3yuI12Gtrqsrx","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/plain":{"content":"'/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid_60.yaml'","content_type":"text/plain"}}},"children":[],"key":"ljxGrfbdDi"}],"key":"FwD2QEc1kf"}],"key":"iD9Btq4wp9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.save(filepath)","key":"sGCXP3yW6p"},{"type":"outputs","id":"niiIj6BbSvX6q0Ila85pr","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:54:08 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc\n"},"children":[],"key":"oit3dCbml5"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":12,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc')]","content_type":"text/plain"}}},"children":[],"key":"oFLn0j5LFa"}],"key":"PrlY4AWDEH"}],"key":"uCLCAJ2yYf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.to_yaml(yaml_filepath)","key":"CnkRzE5rzB"},{"type":"outputs","id":"N_ezLl19gJ7glwM0WIBjV","children":[],"key":"wTh7KDwCge"}],"key":"hllG83cu3K"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tpxo_path = datasets+\"TPXO/TPXO10.v2/\"\ntpxo_dict = {\n    \"grid\": tpxo_path + \"grid_tpxo10v2.nc\",\n    \"h\": tpxo_path + \"h_tpxo10.v2.nc\",\n    \"u\": tpxo_path + \"u_tpxo10.v2.nc\",\n}","key":"assmtXs1yJ"},{"type":"outputs","id":"ssqcS5gD8hCRj3SBlWuYr","children":[],"key":"rRQttOCppW"}],"key":"wrNMTrOZNc"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next, we set up tidal forcing:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XzyKhHwlAu"}],"key":"ONfnPHABR3"}],"key":"YKvNrxY0wn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import TidalForcing","key":"gs10Ph7lG9"},{"type":"outputs","id":"l95yd4T4t7ZR5xaWcPGrr","children":[],"key":"YhTtQ7Oo0r"}],"key":"VgAvqMLOv4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from datetime import datetime","key":"uE5mWvSaQ0"},{"type":"outputs","id":"zuqClf3LFis9onmHUw-4O","children":[],"key":"UyPS3sNFar"}],"key":"CSIKvKSR3X"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model_reference_date = datetime(2000, 1, 1)","key":"PRXNvf38uk"},{"type":"outputs","id":"oCcbGueD-H5lKXqliss6B","children":[],"key":"i2xJkktNuO"}],"key":"KZx5ODXK52"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\ntidal_forcing = TidalForcing(\n    grid=grid,\n    source={\"name\": \"TPXO\", \"path\": tpxo_dict},\n    ntides=15,  # Number of constituents to consider <= 15. Default is 10.\n    model_reference_date=model_reference_date,  # Model reference date. Default is January 1, 2000.\n    use_dask=True\n)","key":"m9K4WSxGGJ"},{"type":"outputs","id":"Uryhfl51VH4L7qbxJTzLD","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"ia8AnU3zsw"}],"key":"FDdPFVfrES"}],"key":"owRzV2PR6O"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_tides.nc\"","key":"itJniHOdAc"},{"type":"outputs","id":"fvtxQ0FSh7fMiDtYLk2ic","children":[],"key":"L5vmsMXvAf"}],"key":"zpeo323uHG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time tidal_forcing.save(filepath)","key":"I7H9Me88ee"},{"type":"outputs","id":"T2BCjrR4q-FYNly1KNY-v","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:38 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc\n"},"children":[],"key":"Rt0BCgO5d0"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 6.04 sms\nCPU times: user 2.87 s, sys: 1.11 s, total: 3.98 s\nWall time: 6.23 s\n"},"children":[],"key":"gQSzljZe2X"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":16,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc')]","content_type":"text/plain"}}},"children":[],"key":"O4NK8Y5U0j"}],"key":"JFbCchFcJO"}],"key":"BhXp3NxEhS"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For the surface forcing, we use ERA5 plus the unified BGC dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CJBGq2Axdd"}],"key":"JAYQjwqFmu"}],"key":"TnB7GlkWab"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, SurfaceForcing","key":"MRFFnuksgW"},{"type":"outputs","id":"70tmHgY5kuCDHFHlGEIwk","children":[],"key":"QKDP1TRYpm"}],"key":"rYVM1NkA9d"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time = datetime(2023, 12, 1)\nend_time = datetime(2024, 6, 30)","key":"nm0DJi0ikP"},{"type":"outputs","id":"XyFSiNIaG627iWlo96r0J","children":[],"key":"N9Ynn1IvW1"}],"key":"TsUlvYSr4Y"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time1 = datetime(2024, 6, 1)\nend_time1 = datetime(2024, 12, 1)","key":"JYY0kQInsT"},{"type":"outputs","id":"-wH7b0WYe_g9EG7lh7m9B","children":[],"key":"rMzWDM3pcA"}],"key":"EmWLRKRjmV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs = {\n    \"grid\": grid,\n    \"start_time\": start_time,\n    \"end_time\": end_time,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"L87Tn1rDNK"},{"type":"outputs","id":"AVTnot3EcCagS0mntdrqr","children":[],"key":"bZoelVv45g"}],"key":"XPx6LyGbAN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs1 = {\n    \"grid\": grid,\n    \"start_time\": start_time1,\n    \"end_time\": end_time1,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"gCIZbLphtb"},{"type":"outputs","id":"Bwaf5rBkmLacSa7fGk46k","children":[],"key":"tzfviR8kT2"}],"key":"lRUWI9mq5x"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing = SurfaceForcing(\n    **surface_forcing_kwargs,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"Z5EqSs2515"},{"type":"outputs","id":"jj0IdBmdTEo7-uRUSAMT8","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:45 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-27 13:04:30 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-27 13:04:30 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:04:33 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"pK1Xh0KXwV"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 49s, sys: 7.95 s, total: 2min 57s\nWall time: 3min\n"},"children":[],"key":"uGSwHQTmbu"}],"key":"WWjJBplgTH"}],"key":"sbtv8322uY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing1 = SurfaceForcing(\n    **surface_forcing_kwargs1,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"M2drAcwRJt"},{"type":"outputs","id":"g6zyL9vziIGfpTk_veAsX","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:55:31 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-29 17:57:16 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-29 17:57:17 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-29 17:57:20 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"ydZevqtdhE"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 34s, sys: 12.6 s, total: 2min 46s\nWall time: 2min 50s\n"},"children":[],"key":"MctSdlN3T3"}],"key":"XKcskk5BXX"}],"key":"RnhVHQjcub"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing.plot(\"uwnd\", time=0)","key":"rVPdp4a2RI"},{"type":"outputs","id":"uCYrogBtsF1dBk-47VZc6","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 101.99 ms\n"},"children":[],"key":"glpm5uEQcD"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"9eb29aed7373f4422cd751ded65ff4c4","path":"/9eb29aed7373f4422cd751ded65ff4c4.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"BgOgQm8E3G"}],"key":"yP8RWIZHsH"}],"key":"UnDS8Z3VA6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#cesm_bgc_path = \"/global/cfs/projectdirs/m4746/Datasets/CESM_REGRIDDED/CESM-surface_lowres_regridded.nc\"\nunified_bgc_path = datasets+\"UNIFIED/BGCdataset.nc\"","key":"QCK1R7io4A"},{"type":"outputs","id":"LwcGFF-NcKeks0x2gOgOc","children":[],"key":"Ji5I9xpHTZ"}],"key":"f375xDnsOT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nunified_bgc_surface_forcing = SurfaceForcing(\n    grid=grid,\n    start_time=start_time,\n    end_time=end_time,\n    source={\"name\": \"UNIFIED\", \"path\": unified_bgc_path, \"climatology\": True},\n    type=\"bgc\",\n    use_dask=True,\n)","key":"qNf0nEDQIl"},{"type":"outputs","id":"xVyksoaNTtxR3u0S3nkJp","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:48 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bgc.opt` ROMS option file.\n2025-10-27 13:05:48 - INFO - 2D horizontal fill is skipped because source data already contains filled values.\n"},"children":[],"key":"xa74OZGSEc"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 145 ms, sys: 8.95 ms, total: 154 ms\nWall time: 299 ms\n"},"children":[],"key":"qfRcr8yJOr"}],"key":"HTFOzKyhp1"}],"key":"lW5GkPBQkH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_surface_forcing2024.nc\"","key":"g2sNaquPie"},{"type":"outputs","id":"rHQWDBIS2M7jNdSEsHOkL","children":[],"key":"kIWpoKQRAQ"}],"key":"gtajQwhoGw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing.save(filepath, group=True)","key":"EXzfBgOhfw"},{"type":"outputs","id":"TxL21buwlBbRZbP-QWIj_","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:53 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n"},"children":[],"key":"Lf3Y4jDMie"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 77.22 s\n[########################################] | 100% Completed | 79.04 s\n[########################################] | 100% Completed | 74.84 s\n[########################################] | 100% Completed | 79.05 s\n[########################################] | 100% Completed | 77.91 s\n[########################################] | 100% Completed | 80.71 s\n[########################################] | 100% Completed | 77.10 s\nCPU times: user 15min 33s, sys: 2min 11s, total: 17min 44s\nWall time: 10min 47s\n"},"children":[],"key":"ziPhJr3nz4"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":25,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc')]","content_type":"text/plain"}}},"children":[],"key":"MSBe1n8wGK"}],"key":"pTxoDddM5V"}],"key":"XQarTYXelx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing1.save(filepath, group=True)","key":"eNuhwcLnEr"},{"type":"outputs","id":"0ulNAeUffQm4Xlj4NPEWP","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:58:23 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc\n"},"children":[],"key":"YRLruh7dNS"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 73.88 s\n[########################################] | 100% Completed | 76.59 s\n[########################################] | 100% Completed | 77.23 s\n[########################################] | 100% Completed | 76.66 s\n[########################################] | 100% Completed | 75.70 s\n[########################################] | 100% Completed | 74.32 s\n[########################################] | 100% Completed | 409.54 ms\nCPU times: user 12min 45s, sys: 2min, total: 14min 45s\nWall time: 9min 6s\n"},"children":[],"key":"Hmo79wJu3t"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":19,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc')]","content_type":"text/plain"}}},"children":[],"key":"rqmjc7QYTF"}],"key":"LYQ3IaELUL"}],"key":"icn6tKh4Pd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_bgc_surface_forcing.nc\"","key":"R5wwx4DqT0"},{"type":"outputs","id":"MR0563xwpLgE4AL3M5nVl","children":[],"key":"vll2V6njLL"}],"key":"k7PjKTnXYj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time unified_bgc_surface_forcing.save(filepath)","key":"oXvLR1TyFC"},{"type":"outputs","id":"afoI_z_wkuWAa10BUKXhn","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:16:36 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc\n"},"children":[],"key":"apA2nQAKwc"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 206.46 ms\nCPU times: user 161 ms, sys: 15 ms, total: 176 ms\nWall time: 310 ms\n"},"children":[],"key":"UTBTTsXtmR"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":27,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc')]","content_type":"text/plain"}}},"children":[],"key":"KQBeGMY4Gs"}],"key":"zNdrr3SBIX"}],"key":"YkPqTJdrln"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next we generate the initial file","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iIOEaHEB6A"}],"key":"w90cqqRYq7"}],"key":"VTTxRwOZsC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, ChildGrid","key":"y5fsPU2Eil"},{"type":"outputs","id":"1TNv_2g2jeosG2gIK3trs","children":[],"key":"XdETXfAOq5"}],"key":"suAGAI6xSP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"parent_grid = grid","key":"W8qAkuDY2X"},{"type":"outputs","id":"phMtWlkhBR-fxSpRTP3lj","children":[],"key":"vw5bMxiaIs"}],"key":"NdJHof6T2h"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid_parameters = {\n    \"nx\": 512,\n    \"ny\": 512,\n    \"size_x\": 102.4,\n    \"size_y\": 102.4,\n    \"center_lon\": -22.4,\n    \"center_lat\": 64.39,\n    \"rot\": 0,\n    \"topography_source\": {\n        \"name\": \"SRTM15\",\n        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n    \"N\":40  # number of vertical layers\n}","key":"Ibf5Zg91PF"},{"type":"outputs","id":"kL_RgcjxNtWzlme2NSh9E","children":[],"key":"EhdWm5xhwO"}],"key":"JVW5jTrhmS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid = ChildGrid(\n    **child_grid_parameters,\n    parent_grid=parent_grid,\n    boundaries={\n        \"south\": True,\n        \"east\": False,\n        \"north\": False,\n        \"west\": True,\n    },  # this is the default\n    metadata={\"prefix\": \"child\", \"period\": 1800.0}  # this is the default\n)","key":"XsteaHi75W"},{"type":"outputs","id":"YvUWGcril1DWdAZtwiM0M","children":[{"type":"output","jupyter_data":{"ename":"ValueError","evalue":"Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.","output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mValueError\u001b[39m                                Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[31]\u001b[39m\u001b[32m, line 1\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m1\u001b[39m child_grid = \u001b[43mChildGrid\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      2\u001b[39m \u001b[43m    \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mchild_grid_parameters\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      3\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m=\u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      4\u001b[39m \u001b[43m    \u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\n\u001b[32m      5\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43msouth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      6\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43meast\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      7\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mnorth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      8\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mwest\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      9\u001b[39m \u001b[43m    \u001b[49m\u001b[43m}\u001b[49m\u001b[43m,\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     10\u001b[39m \u001b[43m    \u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mchild\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[32;43m1800.0\u001b[39;49m\u001b[43m}\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     11\u001b[39m \u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m<string>:20\u001b[39m, in \u001b[36m__init__\u001b[39m\u001b[34m(self, nx, ny, size_x, size_y, center_lon, center_lat, rot, N, theta_s, theta_b, hc, topography_source, hmin, verbose, parent_grid, boundaries, metadata)\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:80\u001b[39m, in \u001b[36mChildGrid.__post_init__\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     78\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m__post_init__\u001b[39m(\u001b[38;5;28mself\u001b[39m):\n\u001b[32m     79\u001b[39m     \u001b[38;5;28msuper\u001b[39m().__post_init__()\n\u001b[32m---> \u001b[39m\u001b[32m80\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_map_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     81\u001b[39m     \u001b[38;5;28mself\u001b[39m._modify_child_topography_and_mask()\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:89\u001b[39m, in \u001b[36mChildGrid._map_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     86\u001b[39m parent_grid_ds, child_grid_ds = \u001b[38;5;28mself\u001b[39m._prepare_grid_datasets()\n\u001b[32m     88\u001b[39m \u001b[38;5;66;03m# Map child boundaries onto parent grid indices\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m89\u001b[39m ds_nesting = \u001b[43mmap_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m     90\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     91\u001b[39m \u001b[43m    \u001b[49m\u001b[43mchild_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     92\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     93\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     94\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     95\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     97\u001b[39m \u001b[38;5;28mself\u001b[39m.ds_nesting = ds_nesting\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:369\u001b[39m, in \u001b[36mmap_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(parent_grid_ds, child_grid_ds, boundaries, prefix, period, update_land_indices)\u001b[39m\n\u001b[32m    363\u001b[39m lat_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mlatitude\u001b[39m\u001b[33m\"\u001b[39m]].isel(\n\u001b[32m    364\u001b[39m     **bdry_coords[direction]\n\u001b[32m    365\u001b[39m )\n\u001b[32m    367\u001b[39m mask_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mmask\u001b[39m\u001b[33m\"\u001b[39m]].isel(**bdry_coords[direction])\n\u001b[32m--> \u001b[39m\u001b[32m369\u001b[39m i_eta, i_xi = \u001b[43minterpolate_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    370\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlon_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlat_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmask_child\u001b[49m\n\u001b[32m    371\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    373\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m update_land_indices:\n\u001b[32m    374\u001b[39m     i_eta, i_xi = update_indices_if_on_parent_land(\n\u001b[32m    375\u001b[39m         i_eta, i_xi, grid_location, parent_grid_ds\n\u001b[32m    376\u001b[39m     )\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:472\u001b[39m, in \u001b[36minterpolate_indices\u001b[39m\u001b[34m(parent_grid_ds, lon, lat, mask)\u001b[39m\n\u001b[32m    470\u001b[39m \u001b[38;5;66;03m# Check for NaN values\u001b[39;00m\n\u001b[32m    471\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m np.sum(np.isnan(i)) > \u001b[32m0\u001b[39m \u001b[38;5;129;01mor\u001b[39;00m np.sum(np.isnan(j)) > \u001b[32m0\u001b[39m:\n\u001b[32m--> \u001b[39m\u001b[32m472\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\n\u001b[32m    473\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33mSome points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m    474\u001b[39m     )\n\u001b[32m    476\u001b[39m \u001b[38;5;66;03m# Check whether indices are close to border of parent grid\u001b[39;00m\n\u001b[32m    477\u001b[39m nxp, nyp = lon_parent.shape\n\n\u001b[31mValueError\u001b[39m: Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid."},"children":[],"key":"Ez1Ha5Ha8O"}],"key":"OfXO4KcPY0"}],"key":"zeskWn9pkc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.plot_nesting(with_dim_names=True)","key":"E5Mz609meP"},{"type":"outputs","id":"G2Dwa-2c9O3KGTCgjMr9e","children":[],"key":"JkEfuOfmQ5"}],"key":"yJBK5G6Ir1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+child_name+\"_grid.nc\"\nchild_grid.save(filepath=filepath)","key":"ECvxGtQ9Bw"},{"type":"outputs","id":"FHGJDgCeRWICCpflu3Xl4","children":[],"key":"SVDOUOmtHy"}],"key":"MHZ29o2GC8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath_nesting = project+child_name+\"_edata.nc\"","key":"d03XBMxQ5I"},{"type":"outputs","id":"a08mJml8SZqU-5-akSPo_","children":[],"key":"Ev2YqFP63w"}],"key":"qh9PHA2ObI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.save_nesting(filepath=filepath_nesting)","key":"PsO6OGuNuM"},{"type":"outputs","id":"Fj_LMvBZ2qUFpg7t6gFyx","children":[],"key":"Mr0cIuI5SR"}],"key":"eJDczC6VEe"}],"key":"Ad2JzE4Qz3"},"references":{"cite":{"order":[],"data":{}}}}