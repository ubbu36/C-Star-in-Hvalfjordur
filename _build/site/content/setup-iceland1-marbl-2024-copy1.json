{"version":3,"kind":"Notebook","sha256":"264fb7f14f77e5e170acb6c5b3021b8cadc156af5c40eb39c5631607b6e812c8","slug":"setup-iceland1-marbl-2024-copy1","location":"/SETUP_Iceland1_MARBL_2024-Copy1.ipynb","dependencies":[],"frontmatter":{"title":"ROMS-TOOLS setup for Iceland1_MARBL_2024","content_includes_title":false,"kernelspec":{"name":"roms-tools","display_name":"Python (My roms-tools Kernel)","language":"python"},"exports":[{"format":"ipynb","filename":"SETUP_Iceland1_MARBL_2024-Copy1.ipynb","url":"/SETUP_Iceland1_MARBL-a286367c3b68a5c64f6116ab2a5d060b.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"First step is to set up the outer grid using ROMS-TOOLS and save the grid file.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EksTA3gCzj"}],"key":"vcXqAiwcCK"}],"key":"Ih0mRdi1sa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid","key":"vUwknpi9TC"},{"type":"outputs","id":"KpicOBAL6XI-gKdm_NHeo","children":[],"key":"XplXBw388E"}],"key":"yA37vc6YVh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"project='/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/'\ndatasets='/anvil/projects/x-ees250129/Datasets_subset/'\nmodel_name='Iceland1'\nchild_name='Iceland2'\ngrid_path='/anvil/projects/x-ees250129/x-uheede/MATLAB/setup_r2r_phys+bgc/1.Make_grid/Iceland1_grid_MAT1.nc'","key":"OCZKvTYP4H"},{"type":"outputs","id":"19N24dheF44V1a8v4SaPV","children":[],"key":"EL8WOkM5Kq"}],"key":"iXSYbNSQ5r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=512,\n#    size_x=384,\n#    size_y=384,\n#    center_lon=-24,\n#    center_lat=64.9,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"hUq8TIOt94"},{"type":"outputs","id":"NhCXwXPEJFAy4np0ANgwX","children":[],"key":"bZ1Cl6kDRc"}],"key":"UxxnFrONmr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=384,\n#    size_x=384,\n#    size_y=288,\n#    center_lon=-22.6,\n#    center_lat=63.55,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"GEiMpT14Ns"},{"type":"outputs","id":"I9xR20Kbq6DgTRcFQyBoN","children":[],"key":"rmzIkSw8uG"}],"key":"TYlI4we3Pg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid = Grid.from_file(grid_path)","key":"rpdYKNvtj2"},{"type":"outputs","id":"RTiUqqxQHLrYv_eiEi3kb","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-11-18 18:34:40 - WARNING - Vertical coordinates (Cs_r, Cs_w) not found in grid file.\n2025-11-18 18:34:40 - INFO - === Preparing the vertical coordinate system using N = 100, theta_s = 5.0, theta_b = 2.0, hc = 300.0 ===\n2025-11-18 18:34:40 - INFO - Total time: 0.003 seconds\n2025-11-18 18:34:40 - INFO - ========================================================================================================\n"},"children":[],"key":"ouIncI22VF"}],"key":"nS3D9eoxgX"}],"key":"Ucns1RV6Jz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.update_vertical_coordinate(N=60, theta_s=5.0, theta_b=2.0, hc=300.0, verbose=False)","key":"J3PpxQGNHl"},{"type":"outputs","id":"8ThOZUXN20iuVRabYUBvT","children":[],"key":"m7rt4NAWCr"}],"key":"ucSrRiUJIi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.plot()","key":"hW5rzLuha2"},{"type":"outputs","id":"li9_6p4kM6WXgJ3abTm0i","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"70240b2ddedc41c2506ea18b24900928","path":"/70240b2ddedc41c2506ea18b24900928.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"HofDcZEcIz"}],"key":"vIuS0fseJ4"}],"key":"fR2hVFIlXe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+'_grid.nc'\nyaml_filepath=project+model_name+'_grid_60.yaml'","key":"oQhEesx3XP"},{"type":"outputs","id":"5-rkpSdXqIYCdunx9lyOP","children":[],"key":"imc2hjB3lI"}],"key":"OquwBPf8Se"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"yaml_filepath","key":"lKZPYjtJe3"},{"type":"outputs","id":"L6Nv6a3mhtdfMeoTsuf5T","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/plain":{"content":"'/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid_60.yaml'","content_type":"text/plain"}}},"children":[],"key":"OFpokx97En"}],"key":"frDTYaOo5C"}],"key":"dc1WadwyVB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.save(filepath)","key":"HqA5uDF8AH"},{"type":"outputs","id":"YssG1ag3T-YzsrrRgLQdf","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:54:08 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc\n"},"children":[],"key":"HHpbLccWqY"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":12,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc')]","content_type":"text/plain"}}},"children":[],"key":"NWqR9MeTrx"}],"key":"vlIACKiMbs"}],"key":"KTW1GhfHHP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.to_yaml(yaml_filepath)","key":"fuVSqiyJv7"},{"type":"outputs","id":"TQ1mfuey1sWe145l_Zxwf","children":[],"key":"e9kqdYuyWJ"}],"key":"PARhE9NLRk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tpxo_path = datasets+\"TPXO/TPXO10.v2/\"\ntpxo_dict = {\n    \"grid\": tpxo_path + \"grid_tpxo10v2.nc\",\n    \"h\": tpxo_path + \"h_tpxo10.v2.nc\",\n    \"u\": tpxo_path + \"u_tpxo10.v2.nc\",\n}","key":"coimZzTXXu"},{"type":"outputs","id":"FqArK8w_QV1wGUvv6KBwP","children":[],"key":"uXnhgGTdu5"}],"key":"waYKFemaDi"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next, we set up tidal forcing:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YKEaitKBmI"}],"key":"aabWRtWN6R"}],"key":"GegfHeb0LS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import TidalForcing","key":"vE5gMWmKHt"},{"type":"outputs","id":"38QQJgs6fGxreySJxGnMz","children":[],"key":"zIxpt0c1qU"}],"key":"n5Lo2AFnz2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from datetime import datetime","key":"HTmlrIRkCt"},{"type":"outputs","id":"0bhWVnrvmo8LSr_tgsJNv","children":[],"key":"gSp31i4hM9"}],"key":"mdCHP3L2wl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model_reference_date = datetime(2000, 1, 1)","key":"c5LQkjLSQh"},{"type":"outputs","id":"0-ROKQf0VMUCRIWBtuD5t","children":[],"key":"x1uX5i5cuV"}],"key":"GoyNCDVOP5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\ntidal_forcing = TidalForcing(\n    grid=grid,\n    source={\"name\": \"TPXO\", \"path\": tpxo_dict},\n    ntides=15,  # Number of constituents to consider <= 15. Default is 10.\n    model_reference_date=model_reference_date,  # Model reference date. Default is January 1, 2000.\n    use_dask=True\n)","key":"QPgZ6RjxF8"},{"type":"outputs","id":"9UJUjSXpJ-jviZ2Mk3X-j","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"rba7YN68XY"}],"key":"k18MlkahJh"}],"key":"RDFUApITg3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_tides.nc\"","key":"aJl0hW2BWd"},{"type":"outputs","id":"b6mJh8G4ffU1zh6nu4h5h","children":[],"key":"Rn3BBNRlAO"}],"key":"GfdbC1eN3L"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time tidal_forcing.save(filepath)","key":"FJ8ygXpD26"},{"type":"outputs","id":"q4U1KHrcZSr2gWjnLXfrl","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:38 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc\n"},"children":[],"key":"Uw79VvUyR4"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 6.04 sms\nCPU times: user 2.87 s, sys: 1.11 s, total: 3.98 s\nWall time: 6.23 s\n"},"children":[],"key":"YprJM7q0mr"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":16,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc')]","content_type":"text/plain"}}},"children":[],"key":"XoF9WM1B3G"}],"key":"PZXbceToHI"}],"key":"ikvnaZZSlo"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For the surface forcing, we use ERA5 plus the unified BGC dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iOdH3CC0u6"}],"key":"PfqNRAe00A"}],"key":"buY6XEVS30"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, SurfaceForcing","key":"J3DFpjJu2E"},{"type":"outputs","id":"7mOeOA74K31YjL2yHRdqZ","children":[],"key":"MuxAkoaUSV"}],"key":"mqmnKuyaku"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time = datetime(2023, 12, 1)\nend_time = datetime(2024, 6, 30)","key":"OqK2bc0x1g"},{"type":"outputs","id":"gNIpodq7JYPYzohLAYGjJ","children":[],"key":"MKjplieV8v"}],"key":"XEJBs6um37"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time1 = datetime(2024, 6, 1)\nend_time1 = datetime(2024, 12, 1)","key":"mnnxlZlaUg"},{"type":"outputs","id":"gl7qQt80fSqtsXMHTM677","children":[],"key":"RLRizv5SeA"}],"key":"U89kJqpSal"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs = {\n    \"grid\": grid,\n    \"start_time\": start_time,\n    \"end_time\": end_time,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"wg3laxMRKg"},{"type":"outputs","id":"qKpwGmuypG6tS8jPvHd-z","children":[],"key":"ti23LIauC0"}],"key":"P7OWbI4c99"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs1 = {\n    \"grid\": grid,\n    \"start_time\": start_time1,\n    \"end_time\": end_time1,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"Fq5kyjg6Ry"},{"type":"outputs","id":"Uu5eKIxTF0vJNG1eAdlh0","children":[],"key":"B6zGJgVPBF"}],"key":"OH9T3greGN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing = SurfaceForcing(\n    **surface_forcing_kwargs,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"yJ48GIUJfL"},{"type":"outputs","id":"slfcxFH8HivtkhjnmxidV","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:45 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-27 13:04:30 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-27 13:04:30 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:04:33 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"ZO18AMheWG"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 49s, sys: 7.95 s, total: 2min 57s\nWall time: 3min\n"},"children":[],"key":"AphMHnN43X"}],"key":"HpLFTfxS2g"}],"key":"Xg1P2KyMF1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing1 = SurfaceForcing(\n    **surface_forcing_kwargs1,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"kZQLCpm4no"},{"type":"outputs","id":"L57mOFmXRh79wqyOgVBVp","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:55:31 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-29 17:57:16 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-29 17:57:17 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-29 17:57:20 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"Q4s6hpehmx"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 34s, sys: 12.6 s, total: 2min 46s\nWall time: 2min 50s\n"},"children":[],"key":"c5HyLL8fcN"}],"key":"wcIU73Jj73"}],"key":"w4PIMMRJO4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing.plot(\"uwnd\", time=0)","key":"ElXh6lh6cI"},{"type":"outputs","id":"r4iXkS-yGDmcHS27j_q2f","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 101.99 ms\n"},"children":[],"key":"kAfr2VON45"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"9eb29aed7373f4422cd751ded65ff4c4","path":"/9eb29aed7373f4422cd751ded65ff4c4.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"ggZKGt2xVM"}],"key":"S62tccwdkp"}],"key":"F3p6J2diun"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#cesm_bgc_path = \"/global/cfs/projectdirs/m4746/Datasets/CESM_REGRIDDED/CESM-surface_lowres_regridded.nc\"\nunified_bgc_path = datasets+\"UNIFIED/BGCdataset.nc\"","key":"qTpvgplyF3"},{"type":"outputs","id":"4WF_FRx9HR5rY923rP5r0","children":[],"key":"xJ6LqassEa"}],"key":"k4KTrjWMlv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nunified_bgc_surface_forcing = SurfaceForcing(\n    grid=grid,\n    start_time=start_time,\n    end_time=end_time,\n    source={\"name\": \"UNIFIED\", \"path\": unified_bgc_path, \"climatology\": True},\n    type=\"bgc\",\n    use_dask=True,\n)","key":"f1Iy8HwqHe"},{"type":"outputs","id":"8vMxqQLLWhlSs4NBXyxf-","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:48 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bgc.opt` ROMS option file.\n2025-10-27 13:05:48 - INFO - 2D horizontal fill is skipped because source data already contains filled values.\n"},"children":[],"key":"UtlhTMbYcn"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 145 ms, sys: 8.95 ms, total: 154 ms\nWall time: 299 ms\n"},"children":[],"key":"f6D5slUh99"}],"key":"FDdX5qZqxD"}],"key":"yhwSD7UdNT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_surface_forcing2024.nc\"","key":"vIODA5ocNQ"},{"type":"outputs","id":"T5eE8V0_EoNQp9DguRI28","children":[],"key":"aFokrwarrk"}],"key":"eXMfCykuBu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing.save(filepath, group=True)","key":"KLhqQrx8zN"},{"type":"outputs","id":"ztiKckHUI7zA2o0JpoeyY","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:53 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n"},"children":[],"key":"Box3r296WE"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 77.22 s\n[########################################] | 100% Completed | 79.04 s\n[########################################] | 100% Completed | 74.84 s\n[########################################] | 100% Completed | 79.05 s\n[########################################] | 100% Completed | 77.91 s\n[########################################] | 100% Completed | 80.71 s\n[########################################] | 100% Completed | 77.10 s\nCPU times: user 15min 33s, sys: 2min 11s, total: 17min 44s\nWall time: 10min 47s\n"},"children":[],"key":"gKn55n5qAn"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":25,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc')]","content_type":"text/plain"}}},"children":[],"key":"aGimSs49EW"}],"key":"gShrfTJBfM"}],"key":"JKyyCRSRit"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing1.save(filepath, group=True)","key":"uiTX71ZSlL"},{"type":"outputs","id":"eu2YB34Vc5So1jz1RoaYU","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:58:23 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc\n"},"children":[],"key":"TG09Tt1VQr"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 73.88 s\n[########################################] | 100% Completed | 76.59 s\n[########################################] | 100% Completed | 77.23 s\n[########################################] | 100% Completed | 76.66 s\n[########################################] | 100% Completed | 75.70 s\n[########################################] | 100% Completed | 74.32 s\n[########################################] | 100% Completed | 409.54 ms\nCPU times: user 12min 45s, sys: 2min, total: 14min 45s\nWall time: 9min 6s\n"},"children":[],"key":"MK4B6FEwuR"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":19,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc')]","content_type":"text/plain"}}},"children":[],"key":"bXLI14AUSX"}],"key":"kdz8qPJ8PV"}],"key":"KagJ6D4mQX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_bgc_surface_forcing.nc\"","key":"uRpFKd4Kn3"},{"type":"outputs","id":"RmVfO8jaZutHinE_gPWvK","children":[],"key":"KUNIg60TyJ"}],"key":"XF4WzU6gBe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time unified_bgc_surface_forcing.save(filepath)","key":"FSf56T866z"},{"type":"outputs","id":"q-TlaMFJsLtOiUEEh47Y0","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:16:36 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc\n"},"children":[],"key":"VauU9SXayQ"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 206.46 ms\nCPU times: user 161 ms, sys: 15 ms, total: 176 ms\nWall time: 310 ms\n"},"children":[],"key":"QW6dYBs2Xr"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":27,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc')]","content_type":"text/plain"}}},"children":[],"key":"X3YjWE73dv"}],"key":"CRWhjNzRPF"}],"key":"VMGcupSsOw"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next we generate the initial file","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yeqTsm5xsJ"}],"key":"CzdQXSwSRg"}],"key":"eqh5nFy9dm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, ChildGrid","key":"G0rfPdAtQV"},{"type":"outputs","id":"W4p60xH1fuHDo56ALxf8Z","children":[],"key":"hz3WWnqWMr"}],"key":"hbypMu00S0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"parent_grid = grid","key":"cMELMcfTAw"},{"type":"outputs","id":"oIe3i1ojHrE_uxNR-JQqi","children":[],"key":"yquE4dI87A"}],"key":"S7tHMhqx8U"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid_parameters = {\n    \"nx\": 512,\n    \"ny\": 512,\n    \"size_x\": 102.4,\n    \"size_y\": 102.4,\n    \"center_lon\": -22.4,\n    \"center_lat\": 64.39,\n    \"rot\": 0,\n    \"topography_source\": {\n        \"name\": \"SRTM15\",\n        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n    \"N\":40  # number of vertical layers\n}","key":"RDMEKKhAph"},{"type":"outputs","id":"F8FHbetaFuleUFDv1w2yW","children":[],"key":"S3zR6L6O8U"}],"key":"kt0E9qiHXW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid = ChildGrid(\n    **child_grid_parameters,\n    parent_grid=parent_grid,\n    boundaries={\n        \"south\": True,\n        \"east\": False,\n        \"north\": False,\n        \"west\": True,\n    },  # this is the default\n    metadata={\"prefix\": \"child\", \"period\": 1800.0}  # this is the default\n)","key":"TToujGggqj"},{"type":"outputs","id":"haqh8B5dP6dfeuIijY_4M","children":[{"type":"output","jupyter_data":{"ename":"ValueError","evalue":"Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.","output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mValueError\u001b[39m                                Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[31]\u001b[39m\u001b[32m, line 1\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m1\u001b[39m child_grid = \u001b[43mChildGrid\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      2\u001b[39m \u001b[43m    \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mchild_grid_parameters\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      3\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m=\u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      4\u001b[39m \u001b[43m    \u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\n\u001b[32m      5\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43msouth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      6\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43meast\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      7\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mnorth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      8\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mwest\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      9\u001b[39m \u001b[43m    \u001b[49m\u001b[43m}\u001b[49m\u001b[43m,\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     10\u001b[39m \u001b[43m    \u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mchild\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[32;43m1800.0\u001b[39;49m\u001b[43m}\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     11\u001b[39m \u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m<string>:20\u001b[39m, in \u001b[36m__init__\u001b[39m\u001b[34m(self, nx, ny, size_x, size_y, center_lon, center_lat, rot, N, theta_s, theta_b, hc, topography_source, hmin, verbose, parent_grid, boundaries, metadata)\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:80\u001b[39m, in \u001b[36mChildGrid.__post_init__\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     78\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m__post_init__\u001b[39m(\u001b[38;5;28mself\u001b[39m):\n\u001b[32m     79\u001b[39m     \u001b[38;5;28msuper\u001b[39m().__post_init__()\n\u001b[32m---> \u001b[39m\u001b[32m80\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_map_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     81\u001b[39m     \u001b[38;5;28mself\u001b[39m._modify_child_topography_and_mask()\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:89\u001b[39m, in \u001b[36mChildGrid._map_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     86\u001b[39m parent_grid_ds, child_grid_ds = \u001b[38;5;28mself\u001b[39m._prepare_grid_datasets()\n\u001b[32m     88\u001b[39m \u001b[38;5;66;03m# Map child boundaries onto parent grid indices\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m89\u001b[39m ds_nesting = \u001b[43mmap_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m     90\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     91\u001b[39m \u001b[43m    \u001b[49m\u001b[43mchild_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     92\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     93\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     94\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     95\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     97\u001b[39m \u001b[38;5;28mself\u001b[39m.ds_nesting = ds_nesting\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:369\u001b[39m, in \u001b[36mmap_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(parent_grid_ds, child_grid_ds, boundaries, prefix, period, update_land_indices)\u001b[39m\n\u001b[32m    363\u001b[39m lat_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mlatitude\u001b[39m\u001b[33m\"\u001b[39m]].isel(\n\u001b[32m    364\u001b[39m     **bdry_coords[direction]\n\u001b[32m    365\u001b[39m )\n\u001b[32m    367\u001b[39m mask_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mmask\u001b[39m\u001b[33m\"\u001b[39m]].isel(**bdry_coords[direction])\n\u001b[32m--> \u001b[39m\u001b[32m369\u001b[39m i_eta, i_xi = \u001b[43minterpolate_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    370\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlon_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlat_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmask_child\u001b[49m\n\u001b[32m    371\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    373\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m update_land_indices:\n\u001b[32m    374\u001b[39m     i_eta, i_xi = update_indices_if_on_parent_land(\n\u001b[32m    375\u001b[39m         i_eta, i_xi, grid_location, parent_grid_ds\n\u001b[32m    376\u001b[39m     )\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:472\u001b[39m, in \u001b[36minterpolate_indices\u001b[39m\u001b[34m(parent_grid_ds, lon, lat, mask)\u001b[39m\n\u001b[32m    470\u001b[39m \u001b[38;5;66;03m# Check for NaN values\u001b[39;00m\n\u001b[32m    471\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m np.sum(np.isnan(i)) > \u001b[32m0\u001b[39m \u001b[38;5;129;01mor\u001b[39;00m np.sum(np.isnan(j)) > \u001b[32m0\u001b[39m:\n\u001b[32m--> \u001b[39m\u001b[32m472\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\n\u001b[32m    473\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33mSome points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m    474\u001b[39m     )\n\u001b[32m    476\u001b[39m \u001b[38;5;66;03m# Check whether indices are close to border of parent grid\u001b[39;00m\n\u001b[32m    477\u001b[39m nxp, nyp = lon_parent.shape\n\n\u001b[31mValueError\u001b[39m: Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid."},"children":[],"key":"lzPG370laL"}],"key":"kciwp84n74"}],"key":"djZOFRf4Sw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.plot_nesting(with_dim_names=True)","key":"FTDqOLAqj7"},{"type":"outputs","id":"00R844x8XskRX1nU07me1","children":[],"key":"Bnw6vyNGhT"}],"key":"JJuq43odjb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+child_name+\"_grid.nc\"\nchild_grid.save(filepath=filepath)","key":"IxjW3SzhyZ"},{"type":"outputs","id":"vufUpf6EepSwXuzKk433q","children":[],"key":"plVw6Vi4ui"}],"key":"Qos2cdUxXv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath_nesting = project+child_name+\"_edata.nc\"","key":"yhRLBQI5Zp"},{"type":"outputs","id":"T1Q_qC-7LV-CtoZ6pjJpH","children":[],"key":"n7xy9GlgAP"}],"key":"XFJ9aDgK0p"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.save_nesting(filepath=filepath_nesting)","key":"AThhcyJBMR"},{"type":"outputs","id":"DdivCenflNXJxJVnZW87i","children":[],"key":"eqV2amZW9n"}],"key":"Q4mLKiMAeS"}],"key":"Erfe7aYlxp"},"references":{"cite":{"order":[],"data":{}}}}