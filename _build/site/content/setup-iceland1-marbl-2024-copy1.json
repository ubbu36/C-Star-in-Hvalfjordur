{"version":3,"kind":"Notebook","sha256":"264fb7f14f77e5e170acb6c5b3021b8cadc156af5c40eb39c5631607b6e812c8","slug":"setup-iceland1-marbl-2024-copy1","location":"/SETUP_Iceland1_MARBL_2024-Copy1.ipynb","dependencies":[],"frontmatter":{"title":"ROMS-TOOLS setup for Iceland1_MARBL_2024","content_includes_title":false,"kernelspec":{"name":"roms-tools","display_name":"Python (My roms-tools Kernel)","language":"python"},"exports":[{"format":"ipynb","filename":"SETUP_Iceland1_MARBL_2024-Copy1.ipynb","url":"/SETUP_Iceland1_MARBL-a286367c3b68a5c64f6116ab2a5d060b.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"First step is to set up the outer grid using ROMS-TOOLS and save the grid file.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ehXiagATUh"}],"key":"GZgIkF4Bku"}],"key":"CAhk3991UT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid","key":"wjmtSR1EZ8"},{"type":"outputs","id":"hW6c8Op_RXPtBdwH6NZAb","children":[],"key":"AplCxj8vlE"}],"key":"Oe7a6bNdwz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"project='/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/'\ndatasets='/anvil/projects/x-ees250129/Datasets_subset/'\nmodel_name='Iceland1'\nchild_name='Iceland2'\ngrid_path='/anvil/projects/x-ees250129/x-uheede/MATLAB/setup_r2r_phys+bgc/1.Make_grid/Iceland1_grid_MAT1.nc'","key":"yXmq6HhIzF"},{"type":"outputs","id":"qnVYeAP0Xj987iDuDxkEL","children":[],"key":"RBpcWnpGp0"}],"key":"H1lxmxupeE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=512,\n#    size_x=384,\n#    size_y=384,\n#    center_lon=-24,\n#    center_lat=64.9,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"cqJw335Fkx"},{"type":"outputs","id":"cTMopemLpnMae5prDavH4","children":[],"key":"Izz6MrNEqd"}],"key":"ZWjnRX3bqO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=384,\n#    size_x=384,\n#    size_y=288,\n#    center_lon=-22.6,\n#    center_lat=63.55,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"M5sE32Cezm"},{"type":"outputs","id":"hE-t8awQSHT3mqBbWzLPi","children":[],"key":"Em75SpVde8"}],"key":"ZWXLHUnR8L"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid = Grid.from_file(grid_path)","key":"DmIHn8vRHl"},{"type":"outputs","id":"ZLM5Hwqq_MQI0auXO0PLG","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-11-18 18:34:40 - WARNING - Vertical coordinates (Cs_r, Cs_w) not found in grid file.\n2025-11-18 18:34:40 - INFO - === Preparing the vertical coordinate system using N = 100, theta_s = 5.0, theta_b = 2.0, hc = 300.0 ===\n2025-11-18 18:34:40 - INFO - Total time: 0.003 seconds\n2025-11-18 18:34:40 - INFO - ========================================================================================================\n"},"children":[],"key":"XE4zIJeNny"}],"key":"VL8aUAuO9l"}],"key":"shMLedqLxe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.update_vertical_coordinate(N=60, theta_s=5.0, theta_b=2.0, hc=300.0, verbose=False)","key":"gUFzQPL62u"},{"type":"outputs","id":"3VD4RxFeCrfFcSlM9tp56","children":[],"key":"s9ZP4NXbgA"}],"key":"fJ1DOlbbud"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.plot()","key":"YQVTpd3G8m"},{"type":"outputs","id":"FPP9uP-VM7_x_73I-2v2Q","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"70240b2ddedc41c2506ea18b24900928","path":"/70240b2ddedc41c2506ea18b24900928.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"KuZ3hvwPza"}],"key":"bAeLeijMfq"}],"key":"osO4EnFKK3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+'_grid.nc'\nyaml_filepath=project+model_name+'_grid_60.yaml'","key":"oY3IIVeDu3"},{"type":"outputs","id":"qxpMIKpqt56wTl5XWxfg7","children":[],"key":"mKzPLejTNa"}],"key":"w5frmFUpQP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"yaml_filepath","key":"NhVbHiCRo8"},{"type":"outputs","id":"esyfX9BbaSzzx9ocbah0P","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/plain":{"content":"'/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid_60.yaml'","content_type":"text/plain"}}},"children":[],"key":"CY0qrcmvon"}],"key":"iK1Fcxh1dF"}],"key":"KWmlpLKsUA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.save(filepath)","key":"SiWzL1JoGn"},{"type":"outputs","id":"-g33Tc9o70CjDBVMGzfMg","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:54:08 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc\n"},"children":[],"key":"ZCuMy0LLMI"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":12,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc')]","content_type":"text/plain"}}},"children":[],"key":"xrRfeTWI6y"}],"key":"dWHerDVPdR"}],"key":"mpP9PcYjmN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.to_yaml(yaml_filepath)","key":"qSbxF4T5he"},{"type":"outputs","id":"VlHYPSl1VAXwXkJbv4hME","children":[],"key":"Y8hsWLhvud"}],"key":"wVANmaqqb1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tpxo_path = datasets+\"TPXO/TPXO10.v2/\"\ntpxo_dict = {\n    \"grid\": tpxo_path + \"grid_tpxo10v2.nc\",\n    \"h\": tpxo_path + \"h_tpxo10.v2.nc\",\n    \"u\": tpxo_path + \"u_tpxo10.v2.nc\",\n}","key":"XiIPPkrEne"},{"type":"outputs","id":"DB3uUJME7VEUhAY3AVexi","children":[],"key":"k1mhFYfdnR"}],"key":"lHH9ldGZdx"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next, we set up tidal forcing:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AazfcqheVV"}],"key":"pW7AnmbWsb"}],"key":"wVRWYJRQOW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import TidalForcing","key":"P9bQWAMJcr"},{"type":"outputs","id":"xq_iG8-Pm_IPmBvW725Pv","children":[],"key":"ticpysbKrp"}],"key":"ARB0HmdCac"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from datetime import datetime","key":"jhezzWwodW"},{"type":"outputs","id":"9Y5uAODbuT7QND3XlF_Wd","children":[],"key":"Zi6cuR7wf0"}],"key":"hwDfOseJW5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model_reference_date = datetime(2000, 1, 1)","key":"flo97AvFGn"},{"type":"outputs","id":"WN-8xjvlA8i-8yH7tPWVq","children":[],"key":"zsWdTNwT1t"}],"key":"AuAVkAzufh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\ntidal_forcing = TidalForcing(\n    grid=grid,\n    source={\"name\": \"TPXO\", \"path\": tpxo_dict},\n    ntides=15,  # Number of constituents to consider <= 15. Default is 10.\n    model_reference_date=model_reference_date,  # Model reference date. Default is January 1, 2000.\n    use_dask=True\n)","key":"jvHcErpa1q"},{"type":"outputs","id":"VCWRNXuU6HlHEKrMY3A4S","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"hF0OJ4Lme7"}],"key":"enlabAwJ0h"}],"key":"puJG3bjgx7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_tides.nc\"","key":"jj2PMAk7gO"},{"type":"outputs","id":"PoV5BWX9Ewt0ouQKftqUW","children":[],"key":"enYRqmzB6O"}],"key":"ILSOMfKc7L"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time tidal_forcing.save(filepath)","key":"LbP8x0jMDe"},{"type":"outputs","id":"OUpEt9vD-Lp6zyb_w61nq","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:38 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc\n"},"children":[],"key":"QWRiIp6PR5"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 6.04 sms\nCPU times: user 2.87 s, sys: 1.11 s, total: 3.98 s\nWall time: 6.23 s\n"},"children":[],"key":"Udss3tMR6D"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":16,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc')]","content_type":"text/plain"}}},"children":[],"key":"GmXCWJY3jv"}],"key":"HHyVLIJzfK"}],"key":"ciijnuSTGf"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For the surface forcing, we use ERA5 plus the unified BGC dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"G3zRzrzr13"}],"key":"Nvz9WNaEj5"}],"key":"T5hmYnenlP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, SurfaceForcing","key":"K2BT9vAG7j"},{"type":"outputs","id":"vqILyaWmsMrUzy3jGrDiP","children":[],"key":"PyxCy9Mc6b"}],"key":"j4Rt5reJEa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time = datetime(2023, 12, 1)\nend_time = datetime(2024, 6, 30)","key":"F3je2al9WF"},{"type":"outputs","id":"f1hm_myGWsimeuirbPxDE","children":[],"key":"A5WzmpCuhy"}],"key":"ul78M9WC29"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time1 = datetime(2024, 6, 1)\nend_time1 = datetime(2024, 12, 1)","key":"YSHRU4GoSY"},{"type":"outputs","id":"AKGC0r_Y2o3u4H1gLnTMd","children":[],"key":"dEBVtLEpNC"}],"key":"aWS1oyeOmN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs = {\n    \"grid\": grid,\n    \"start_time\": start_time,\n    \"end_time\": end_time,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"CmmPaNVlG0"},{"type":"outputs","id":"3aC-hTdHUxce44siLwUXf","children":[],"key":"Bf2Wb79n5h"}],"key":"fgI0r2PBT5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs1 = {\n    \"grid\": grid,\n    \"start_time\": start_time1,\n    \"end_time\": end_time1,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"gnqUn0AYVG"},{"type":"outputs","id":"oj0OUfseabpg8HApZwukZ","children":[],"key":"uQ6lM3ZnOJ"}],"key":"mRi3BRe9xc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing = SurfaceForcing(\n    **surface_forcing_kwargs,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"O8OviMvxt5"},{"type":"outputs","id":"G7EAx6_emK7SwmTWihvLU","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:45 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-27 13:04:30 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-27 13:04:30 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:04:33 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"nMmLA1rhpc"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 49s, sys: 7.95 s, total: 2min 57s\nWall time: 3min\n"},"children":[],"key":"Yn0ji9czDl"}],"key":"a7OnTSfiDn"}],"key":"gBaNzeLDSe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing1 = SurfaceForcing(\n    **surface_forcing_kwargs1,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"N8qDFxJ8ey"},{"type":"outputs","id":"mh7JCQ6BuqPe1eHLhrKdO","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:55:31 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-29 17:57:16 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-29 17:57:17 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-29 17:57:20 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"kEsxveRSFz"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 34s, sys: 12.6 s, total: 2min 46s\nWall time: 2min 50s\n"},"children":[],"key":"kPtgqAxbH7"}],"key":"g6WnR8nU0N"}],"key":"V1mZPzyfhH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing.plot(\"uwnd\", time=0)","key":"bfn6hUKQeD"},{"type":"outputs","id":"2e7aHqKGN8a-B-y5_Cnpy","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 101.99 ms\n"},"children":[],"key":"ROebg5G3P1"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"9eb29aed7373f4422cd751ded65ff4c4","path":"/9eb29aed7373f4422cd751ded65ff4c4.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"PD9o7HrpPk"}],"key":"LcX46GVWhs"}],"key":"niB77bZ3ed"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#cesm_bgc_path = \"/global/cfs/projectdirs/m4746/Datasets/CESM_REGRIDDED/CESM-surface_lowres_regridded.nc\"\nunified_bgc_path = datasets+\"UNIFIED/BGCdataset.nc\"","key":"XiZ4lmb95Y"},{"type":"outputs","id":"pB12wG7GfRquKmIzqMZXP","children":[],"key":"LzRDsWHQIM"}],"key":"ug5ZjIZZ6C"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nunified_bgc_surface_forcing = SurfaceForcing(\n    grid=grid,\n    start_time=start_time,\n    end_time=end_time,\n    source={\"name\": \"UNIFIED\", \"path\": unified_bgc_path, \"climatology\": True},\n    type=\"bgc\",\n    use_dask=True,\n)","key":"n08DZRAgro"},{"type":"outputs","id":"CPBdpnk-lmJokhnI9FLCN","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:48 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bgc.opt` ROMS option file.\n2025-10-27 13:05:48 - INFO - 2D horizontal fill is skipped because source data already contains filled values.\n"},"children":[],"key":"ItqLYM1ltu"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 145 ms, sys: 8.95 ms, total: 154 ms\nWall time: 299 ms\n"},"children":[],"key":"jSwKOisYBn"}],"key":"JI9cpb4PpQ"}],"key":"xQKd7ZdZHT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_surface_forcing2024.nc\"","key":"yke0Xu0KKz"},{"type":"outputs","id":"wd1KG3nxzT5Rzxyl2hw6y","children":[],"key":"ddGFzSSQub"}],"key":"F3ukEpsfit"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing.save(filepath, group=True)","key":"i6n36xS16J"},{"type":"outputs","id":"0rk8TwelnjZmA7MAn_Ja3","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:53 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n"},"children":[],"key":"NOOae1Rid0"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 77.22 s\n[########################################] | 100% Completed | 79.04 s\n[########################################] | 100% Completed | 74.84 s\n[########################################] | 100% Completed | 79.05 s\n[########################################] | 100% Completed | 77.91 s\n[########################################] | 100% Completed | 80.71 s\n[########################################] | 100% Completed | 77.10 s\nCPU times: user 15min 33s, sys: 2min 11s, total: 17min 44s\nWall time: 10min 47s\n"},"children":[],"key":"lQ3Trl88pA"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":25,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc')]","content_type":"text/plain"}}},"children":[],"key":"off4jtaui2"}],"key":"JXUq6lRN6Z"}],"key":"g4EtaBOasM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing1.save(filepath, group=True)","key":"xUm0IDHi3c"},{"type":"outputs","id":"65D-7JWuhn6xe9zonLS70","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:58:23 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc\n"},"children":[],"key":"JkkNSnnWTQ"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 73.88 s\n[########################################] | 100% Completed | 76.59 s\n[########################################] | 100% Completed | 77.23 s\n[########################################] | 100% Completed | 76.66 s\n[########################################] | 100% Completed | 75.70 s\n[########################################] | 100% Completed | 74.32 s\n[########################################] | 100% Completed | 409.54 ms\nCPU times: user 12min 45s, sys: 2min, total: 14min 45s\nWall time: 9min 6s\n"},"children":[],"key":"CVrUEb86hx"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":19,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc')]","content_type":"text/plain"}}},"children":[],"key":"z6zV9MIqIw"}],"key":"cfjTArqKcZ"}],"key":"HM2wsJyzBU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_bgc_surface_forcing.nc\"","key":"d2XyvsQxw3"},{"type":"outputs","id":"BRo3updl5BtOzww3m2R4Z","children":[],"key":"QjjrJDa00y"}],"key":"HacPsfkWUi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time unified_bgc_surface_forcing.save(filepath)","key":"swXYrBaoZL"},{"type":"outputs","id":"UFPFmf4VvTbFwQt8zhvr7","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:16:36 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc\n"},"children":[],"key":"sVv2Hjnekx"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 206.46 ms\nCPU times: user 161 ms, sys: 15 ms, total: 176 ms\nWall time: 310 ms\n"},"children":[],"key":"q7fbZalQrb"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":27,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc')]","content_type":"text/plain"}}},"children":[],"key":"BKAivqW5q4"}],"key":"IrA13pzZC6"}],"key":"umw9N9PaQp"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next we generate the initial file","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RFKMKAEPdJ"}],"key":"RiUOXtB35O"}],"key":"brSymQuQZG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, ChildGrid","key":"lWLNDpM1h6"},{"type":"outputs","id":"mCqqvmGIJH5tmga8OQ_RN","children":[],"key":"fEdYOKeZCq"}],"key":"gqjHsge2Wy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"parent_grid = grid","key":"Wq2M22iXv6"},{"type":"outputs","id":"hyCEzHtt8YUPyhrg2hbqe","children":[],"key":"khLAx8ORFj"}],"key":"Ay1CETzwIo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid_parameters = {\n    \"nx\": 512,\n    \"ny\": 512,\n    \"size_x\": 102.4,\n    \"size_y\": 102.4,\n    \"center_lon\": -22.4,\n    \"center_lat\": 64.39,\n    \"rot\": 0,\n    \"topography_source\": {\n        \"name\": \"SRTM15\",\n        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n    \"N\":40  # number of vertical layers\n}","key":"ccQcmIAQTz"},{"type":"outputs","id":"8I_0ZfYKg-wCuCtf1R75q","children":[],"key":"gJQD29VddU"}],"key":"BNAc0Fkbxm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid = ChildGrid(\n    **child_grid_parameters,\n    parent_grid=parent_grid,\n    boundaries={\n        \"south\": True,\n        \"east\": False,\n        \"north\": False,\n        \"west\": True,\n    },  # this is the default\n    metadata={\"prefix\": \"child\", \"period\": 1800.0}  # this is the default\n)","key":"fURfRDGbz3"},{"type":"outputs","id":"SjjX7mH5IF9HSJtjChiTb","children":[{"type":"output","jupyter_data":{"ename":"ValueError","evalue":"Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.","output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mValueError\u001b[39m                                Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[31]\u001b[39m\u001b[32m, line 1\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m1\u001b[39m child_grid = \u001b[43mChildGrid\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      2\u001b[39m \u001b[43m    \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mchild_grid_parameters\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      3\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m=\u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      4\u001b[39m \u001b[43m    \u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\n\u001b[32m      5\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43msouth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      6\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43meast\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      7\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mnorth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      8\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mwest\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      9\u001b[39m \u001b[43m    \u001b[49m\u001b[43m}\u001b[49m\u001b[43m,\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     10\u001b[39m \u001b[43m    \u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mchild\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[32;43m1800.0\u001b[39;49m\u001b[43m}\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     11\u001b[39m \u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m<string>:20\u001b[39m, in \u001b[36m__init__\u001b[39m\u001b[34m(self, nx, ny, size_x, size_y, center_lon, center_lat, rot, N, theta_s, theta_b, hc, topography_source, hmin, verbose, parent_grid, boundaries, metadata)\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:80\u001b[39m, in \u001b[36mChildGrid.__post_init__\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     78\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m__post_init__\u001b[39m(\u001b[38;5;28mself\u001b[39m):\n\u001b[32m     79\u001b[39m     \u001b[38;5;28msuper\u001b[39m().__post_init__()\n\u001b[32m---> \u001b[39m\u001b[32m80\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_map_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     81\u001b[39m     \u001b[38;5;28mself\u001b[39m._modify_child_topography_and_mask()\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:89\u001b[39m, in \u001b[36mChildGrid._map_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     86\u001b[39m parent_grid_ds, child_grid_ds = \u001b[38;5;28mself\u001b[39m._prepare_grid_datasets()\n\u001b[32m     88\u001b[39m \u001b[38;5;66;03m# Map child boundaries onto parent grid indices\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m89\u001b[39m ds_nesting = \u001b[43mmap_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m     90\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     91\u001b[39m \u001b[43m    \u001b[49m\u001b[43mchild_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     92\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     93\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     94\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     95\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     97\u001b[39m \u001b[38;5;28mself\u001b[39m.ds_nesting = ds_nesting\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:369\u001b[39m, in \u001b[36mmap_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(parent_grid_ds, child_grid_ds, boundaries, prefix, period, update_land_indices)\u001b[39m\n\u001b[32m    363\u001b[39m lat_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mlatitude\u001b[39m\u001b[33m\"\u001b[39m]].isel(\n\u001b[32m    364\u001b[39m     **bdry_coords[direction]\n\u001b[32m    365\u001b[39m )\n\u001b[32m    367\u001b[39m mask_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mmask\u001b[39m\u001b[33m\"\u001b[39m]].isel(**bdry_coords[direction])\n\u001b[32m--> \u001b[39m\u001b[32m369\u001b[39m i_eta, i_xi = \u001b[43minterpolate_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    370\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlon_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlat_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmask_child\u001b[49m\n\u001b[32m    371\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    373\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m update_land_indices:\n\u001b[32m    374\u001b[39m     i_eta, i_xi = update_indices_if_on_parent_land(\n\u001b[32m    375\u001b[39m         i_eta, i_xi, grid_location, parent_grid_ds\n\u001b[32m    376\u001b[39m     )\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:472\u001b[39m, in \u001b[36minterpolate_indices\u001b[39m\u001b[34m(parent_grid_ds, lon, lat, mask)\u001b[39m\n\u001b[32m    470\u001b[39m \u001b[38;5;66;03m# Check for NaN values\u001b[39;00m\n\u001b[32m    471\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m np.sum(np.isnan(i)) > \u001b[32m0\u001b[39m \u001b[38;5;129;01mor\u001b[39;00m np.sum(np.isnan(j)) > \u001b[32m0\u001b[39m:\n\u001b[32m--> \u001b[39m\u001b[32m472\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\n\u001b[32m    473\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33mSome points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m    474\u001b[39m     )\n\u001b[32m    476\u001b[39m \u001b[38;5;66;03m# Check whether indices are close to border of parent grid\u001b[39;00m\n\u001b[32m    477\u001b[39m nxp, nyp = lon_parent.shape\n\n\u001b[31mValueError\u001b[39m: Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid."},"children":[],"key":"LKsiesj9Je"}],"key":"YJVZRczjXp"}],"key":"p6G1XMco1G"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.plot_nesting(with_dim_names=True)","key":"eUSMI8gm57"},{"type":"outputs","id":"FlDTLtxqipt8a4O_Uj4Le","children":[],"key":"o60B7eVQ8b"}],"key":"eguWEidzlL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+child_name+\"_grid.nc\"\nchild_grid.save(filepath=filepath)","key":"ehns657mXW"},{"type":"outputs","id":"h5wXCXfAzEK5-fP-NylMi","children":[],"key":"a0XINPF1bW"}],"key":"uusireh9AG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath_nesting = project+child_name+\"_edata.nc\"","key":"Lu1AI4albA"},{"type":"outputs","id":"kR5bWEfU28V5rMRP85VPz","children":[],"key":"FSypkUekfI"}],"key":"v2l2xSquKN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.save_nesting(filepath=filepath_nesting)","key":"ZULNNmVLgI"},{"type":"outputs","id":"2k1-eoeSF9dJn1dZx-g6N","children":[],"key":"jwpp7IjCjx"}],"key":"sqt845VLb0"}],"key":"XBsOptzPIm"},"references":{"cite":{"order":[],"data":{}}}}