{"version":3,"kind":"Notebook","sha256":"264fb7f14f77e5e170acb6c5b3021b8cadc156af5c40eb39c5631607b6e812c8","slug":"setup-iceland1-marbl-2024-copy1","location":"/SETUP_Iceland1_MARBL_2024-Copy1.ipynb","dependencies":[],"frontmatter":{"title":"ROMS-TOOLS setup for Iceland1_MARBL_2024","content_includes_title":false,"kernelspec":{"name":"roms-tools","display_name":"Python (My roms-tools Kernel)","language":"python"},"exports":[{"format":"ipynb","filename":"SETUP_Iceland1_MARBL_2024-Copy1.ipynb","url":"/SETUP_Iceland1_MARBL-a286367c3b68a5c64f6116ab2a5d060b.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"First step is to set up the outer grid using ROMS-TOOLS and save the grid file.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PAEjqho6bY"}],"key":"dxPT6KPP8b"}],"key":"y50JGI4wHj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid","key":"dZUxCskcIZ"},{"type":"outputs","id":"N7btVwIS4k8RzCrj-uiml","children":[],"key":"aGLXGROf1f"}],"key":"JNOxaptwGp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"project='/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/'\ndatasets='/anvil/projects/x-ees250129/Datasets_subset/'\nmodel_name='Iceland1'\nchild_name='Iceland2'\ngrid_path='/anvil/projects/x-ees250129/x-uheede/MATLAB/setup_r2r_phys+bgc/1.Make_grid/Iceland1_grid_MAT1.nc'","key":"PbLrWZblOK"},{"type":"outputs","id":"r0kT2KnRKoRRH85cxFO4v","children":[],"key":"SLgl42cDHt"}],"key":"lhkM1m3FeS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=512,\n#    size_x=384,\n#    size_y=384,\n#    center_lon=-24,\n#    center_lat=64.9,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"GkUIrdac35"},{"type":"outputs","id":"FBDAegocDPzTE7mOrFrUm","children":[],"key":"qitzyAPyK8"}],"key":"gUfrrvPlWq"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=384,\n#    size_x=384,\n#    size_y=288,\n#    center_lon=-22.6,\n#    center_lat=63.55,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"biTKSemgMt"},{"type":"outputs","id":"RNAF8wqLTSq2W9qRWREGF","children":[],"key":"JtGoIJPkID"}],"key":"ufj0AAAwfE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid = Grid.from_file(grid_path)","key":"Vvx3NyP4dy"},{"type":"outputs","id":"kbA4uUWEZstqcVG-96yGr","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-11-18 18:34:40 - WARNING - Vertical coordinates (Cs_r, Cs_w) not found in grid file.\n2025-11-18 18:34:40 - INFO - === Preparing the vertical coordinate system using N = 100, theta_s = 5.0, theta_b = 2.0, hc = 300.0 ===\n2025-11-18 18:34:40 - INFO - Total time: 0.003 seconds\n2025-11-18 18:34:40 - INFO - ========================================================================================================\n"},"children":[],"key":"IHOq3lUf8g"}],"key":"eM8LKd9AuL"}],"key":"EpS6yZXpIH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.update_vertical_coordinate(N=60, theta_s=5.0, theta_b=2.0, hc=300.0, verbose=False)","key":"C9Glx2hWkW"},{"type":"outputs","id":"_mYLa8tZ4g1U-GY0iwZTL","children":[],"key":"yTCq45lVji"}],"key":"kR6ua9Jntk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.plot()","key":"NOTqPl5p62"},{"type":"outputs","id":"DRumoTslKbHUr-xOUpHa8","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"70240b2ddedc41c2506ea18b24900928","path":"/70240b2ddedc41c2506ea18b24900928.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"D7i3UYYzzj"}],"key":"hcRqx0BN6L"}],"key":"mye7b7hSja"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+'_grid.nc'\nyaml_filepath=project+model_name+'_grid_60.yaml'","key":"xRzz8DLusM"},{"type":"outputs","id":"VTLyHFN4MV6UyZEuw3g2-","children":[],"key":"BM3oUU05ij"}],"key":"ouvymWS6H0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"yaml_filepath","key":"WETNQnXGbm"},{"type":"outputs","id":"GS3gogWk9lNs23NTpGOPX","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/plain":{"content":"'/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid_60.yaml'","content_type":"text/plain"}}},"children":[],"key":"tYu4oJWjm0"}],"key":"SPVI74vziV"}],"key":"E6eVqX8IIA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.save(filepath)","key":"pDKxqx1Y57"},{"type":"outputs","id":"fTzxYfYMUaa03BnZdmBbc","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:54:08 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc\n"},"children":[],"key":"YElmW9UY60"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":12,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc')]","content_type":"text/plain"}}},"children":[],"key":"QGhZEw5xV0"}],"key":"uxNNaim8IV"}],"key":"NrsOo5olyb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.to_yaml(yaml_filepath)","key":"Q83OdL4UFO"},{"type":"outputs","id":"6i1ODHvOk1DPF6IEkwvFb","children":[],"key":"h8b5CukMoa"}],"key":"HNqy5J9I7w"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tpxo_path = datasets+\"TPXO/TPXO10.v2/\"\ntpxo_dict = {\n    \"grid\": tpxo_path + \"grid_tpxo10v2.nc\",\n    \"h\": tpxo_path + \"h_tpxo10.v2.nc\",\n    \"u\": tpxo_path + \"u_tpxo10.v2.nc\",\n}","key":"xBmZSABPrn"},{"type":"outputs","id":"wOlml5zGn4yI1UDpFM8sa","children":[],"key":"nwKYtSkvfM"}],"key":"UwvDgfBZmV"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next, we set up tidal forcing:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lrVYRic0ZF"}],"key":"D8T7iTTjeh"}],"key":"QJ53wCIIwI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import TidalForcing","key":"KNXhf4Kub7"},{"type":"outputs","id":"KLm45aU0bDAE00X_gIhqJ","children":[],"key":"oWtl9kQ2Kf"}],"key":"TBxixfpdAn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from datetime import datetime","key":"VjIZtIS2iD"},{"type":"outputs","id":"6bzav8kOw0Gh0xPeeeDFb","children":[],"key":"XshkM1PW8M"}],"key":"QfM3qpXxPx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model_reference_date = datetime(2000, 1, 1)","key":"EJrOyQ9nC6"},{"type":"outputs","id":"cYdBv5f_jEx45b2iT5Tet","children":[],"key":"ZzFlkDvHmw"}],"key":"ldbHoO26nu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\ntidal_forcing = TidalForcing(\n    grid=grid,\n    source={\"name\": \"TPXO\", \"path\": tpxo_dict},\n    ntides=15,  # Number of constituents to consider <= 15. Default is 10.\n    model_reference_date=model_reference_date,  # Model reference date. Default is January 1, 2000.\n    use_dask=True\n)","key":"bhjNOyXiXD"},{"type":"outputs","id":"S0Nim9BSZcPwAiCt9eGST","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"ZYsvOYmLm8"}],"key":"BYNRXnxjNM"}],"key":"KVD7w310We"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_tides.nc\"","key":"LZc7358zTQ"},{"type":"outputs","id":"Zvpaa1mKslWUmBkfIFfmM","children":[],"key":"XSrYe5ZsQ1"}],"key":"PXaRYPR5AK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time tidal_forcing.save(filepath)","key":"qGIHnBRjsN"},{"type":"outputs","id":"bSGTNp2PCSqElm4ONziKO","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:38 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc\n"},"children":[],"key":"WxqZQUZvYh"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 6.04 sms\nCPU times: user 2.87 s, sys: 1.11 s, total: 3.98 s\nWall time: 6.23 s\n"},"children":[],"key":"pUcVpM2bRc"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":16,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc')]","content_type":"text/plain"}}},"children":[],"key":"haodrxU9sE"}],"key":"lhI4yZjfAL"}],"key":"iGNBfUgzTL"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For the surface forcing, we use ERA5 plus the unified BGC dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vh1flbeOLu"}],"key":"tkfLNBrXzJ"}],"key":"ujx8GOfRpQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, SurfaceForcing","key":"C98Xs18O9Q"},{"type":"outputs","id":"-Yr9CiUpjduedbLc-vT-a","children":[],"key":"iOoj3Nc9Ow"}],"key":"Hw9DLkCzL3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time = datetime(2023, 12, 1)\nend_time = datetime(2024, 6, 30)","key":"aiTWBulZY4"},{"type":"outputs","id":"E8xArTWqvx0neAgdg3o_b","children":[],"key":"IoC0wmDjTh"}],"key":"WanmSber95"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time1 = datetime(2024, 6, 1)\nend_time1 = datetime(2024, 12, 1)","key":"P4HnnBtpgZ"},{"type":"outputs","id":"h7zVlOBgrN526JDiApiz_","children":[],"key":"A6N7UjQm8V"}],"key":"Jv6iP01sM6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs = {\n    \"grid\": grid,\n    \"start_time\": start_time,\n    \"end_time\": end_time,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"KU7MZz5RNM"},{"type":"outputs","id":"LgmlkML43aHvGa2x87iTu","children":[],"key":"uNGtS3j6nm"}],"key":"yImCiVdPv4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs1 = {\n    \"grid\": grid,\n    \"start_time\": start_time1,\n    \"end_time\": end_time1,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"AApEsgjJRa"},{"type":"outputs","id":"uQMwxRKfpw7Ti7hzbds-i","children":[],"key":"BF2rn71Skd"}],"key":"KSYtJZtuxm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing = SurfaceForcing(\n    **surface_forcing_kwargs,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"NfXd8w6LLs"},{"type":"outputs","id":"VfYb9sTZVjvqzxh4xyUnn","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:45 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-27 13:04:30 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-27 13:04:30 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:04:33 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"E2f1HtUGml"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 49s, sys: 7.95 s, total: 2min 57s\nWall time: 3min\n"},"children":[],"key":"MRZ9odue76"}],"key":"g6orbAVprO"}],"key":"NeF8q61mPh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing1 = SurfaceForcing(\n    **surface_forcing_kwargs1,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"PaMbEpl0MN"},{"type":"outputs","id":"tz3fZUYTDLiuiwudvOidg","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:55:31 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-29 17:57:16 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-29 17:57:17 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-29 17:57:20 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"XPPotJctTd"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 34s, sys: 12.6 s, total: 2min 46s\nWall time: 2min 50s\n"},"children":[],"key":"e1i7yDzWSO"}],"key":"QTNBzhuQ7d"}],"key":"uXYbjMoA07"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing.plot(\"uwnd\", time=0)","key":"DhJyG4Io8i"},{"type":"outputs","id":"YwojfHunlBCpzlkJjoBMM","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 101.99 ms\n"},"children":[],"key":"Yel5ikF5nH"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"9eb29aed7373f4422cd751ded65ff4c4","path":"/9eb29aed7373f4422cd751ded65ff4c4.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"HFXBEJzJQf"}],"key":"i1OLbLVVYC"}],"key":"GEK1DVoLi6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#cesm_bgc_path = \"/global/cfs/projectdirs/m4746/Datasets/CESM_REGRIDDED/CESM-surface_lowres_regridded.nc\"\nunified_bgc_path = datasets+\"UNIFIED/BGCdataset.nc\"","key":"FHxUNaYnJA"},{"type":"outputs","id":"Bj-8fYlxjQRn0l8tBwb_h","children":[],"key":"R999LeyZho"}],"key":"oY9fKEi4YW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nunified_bgc_surface_forcing = SurfaceForcing(\n    grid=grid,\n    start_time=start_time,\n    end_time=end_time,\n    source={\"name\": \"UNIFIED\", \"path\": unified_bgc_path, \"climatology\": True},\n    type=\"bgc\",\n    use_dask=True,\n)","key":"VULhljwdkO"},{"type":"outputs","id":"H4X7gyfCtYID6QWGWSRPs","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:48 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bgc.opt` ROMS option file.\n2025-10-27 13:05:48 - INFO - 2D horizontal fill is skipped because source data already contains filled values.\n"},"children":[],"key":"TL706ThM2F"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 145 ms, sys: 8.95 ms, total: 154 ms\nWall time: 299 ms\n"},"children":[],"key":"qGmNFkXIy5"}],"key":"pEXdOI1Wf8"}],"key":"VP7tjmDW6b"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_surface_forcing2024.nc\"","key":"OmqsKlTLC9"},{"type":"outputs","id":"_BvbB7vvBpfbVzJ1zz9Rl","children":[],"key":"NBAOw7Eepn"}],"key":"aOVQbT1VCE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing.save(filepath, group=True)","key":"YCdCguZER0"},{"type":"outputs","id":"WA-gaGU0piLx61YeL638i","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:53 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n"},"children":[],"key":"xpu67dzZhV"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 77.22 s\n[########################################] | 100% Completed | 79.04 s\n[########################################] | 100% Completed | 74.84 s\n[########################################] | 100% Completed | 79.05 s\n[########################################] | 100% Completed | 77.91 s\n[########################################] | 100% Completed | 80.71 s\n[########################################] | 100% Completed | 77.10 s\nCPU times: user 15min 33s, sys: 2min 11s, total: 17min 44s\nWall time: 10min 47s\n"},"children":[],"key":"R1gehIaEEc"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":25,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc')]","content_type":"text/plain"}}},"children":[],"key":"YukLghot4W"}],"key":"Le1K3vSGrz"}],"key":"m39ypDxcjr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing1.save(filepath, group=True)","key":"DmVBaeJ2oQ"},{"type":"outputs","id":"DL7BmwurMaA-LM9a8b377","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:58:23 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc\n"},"children":[],"key":"klrPATcH8p"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 73.88 s\n[########################################] | 100% Completed | 76.59 s\n[########################################] | 100% Completed | 77.23 s\n[########################################] | 100% Completed | 76.66 s\n[########################################] | 100% Completed | 75.70 s\n[########################################] | 100% Completed | 74.32 s\n[########################################] | 100% Completed | 409.54 ms\nCPU times: user 12min 45s, sys: 2min, total: 14min 45s\nWall time: 9min 6s\n"},"children":[],"key":"mDJI5CmkQZ"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":19,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc')]","content_type":"text/plain"}}},"children":[],"key":"haANONplyt"}],"key":"OcbRKRaSAa"}],"key":"XymcPA99oV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_bgc_surface_forcing.nc\"","key":"rSBnlSMrzt"},{"type":"outputs","id":"kDA2sx6VfLSiSC3DAPk-p","children":[],"key":"NYVzAm2WmL"}],"key":"DHirUPhTNA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time unified_bgc_surface_forcing.save(filepath)","key":"kdeHrFrlZQ"},{"type":"outputs","id":"JkKXNUkA8F14c3Vcl0G7B","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:16:36 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc\n"},"children":[],"key":"a52Pb745FQ"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 206.46 ms\nCPU times: user 161 ms, sys: 15 ms, total: 176 ms\nWall time: 310 ms\n"},"children":[],"key":"JXDdVOw7x7"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":27,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc')]","content_type":"text/plain"}}},"children":[],"key":"a62b1aikrb"}],"key":"mQL5NhByB2"}],"key":"CE5SUvBWWf"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next we generate the initial file","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uki9tiGjDI"}],"key":"bZGO4a2P5c"}],"key":"NWWkrp3DPc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, ChildGrid","key":"bKF5Pipo9u"},{"type":"outputs","id":"TElD9wr3A6mGwzSgv---m","children":[],"key":"U4wB8zPBoI"}],"key":"CwDHnl4Egl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"parent_grid = grid","key":"dGjIG3lXlG"},{"type":"outputs","id":"Sm-xu1pZDYlBOmzhVPvnf","children":[],"key":"u0u5S71PlS"}],"key":"h3tdYNQNfp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid_parameters = {\n    \"nx\": 512,\n    \"ny\": 512,\n    \"size_x\": 102.4,\n    \"size_y\": 102.4,\n    \"center_lon\": -22.4,\n    \"center_lat\": 64.39,\n    \"rot\": 0,\n    \"topography_source\": {\n        \"name\": \"SRTM15\",\n        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n    \"N\":40  # number of vertical layers\n}","key":"W9MCMdR0Ps"},{"type":"outputs","id":"SVm7aPYYXe28vIsI-AScw","children":[],"key":"CWnxJhLUbz"}],"key":"OFhTZ2liYa"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid = ChildGrid(\n    **child_grid_parameters,\n    parent_grid=parent_grid,\n    boundaries={\n        \"south\": True,\n        \"east\": False,\n        \"north\": False,\n        \"west\": True,\n    },  # this is the default\n    metadata={\"prefix\": \"child\", \"period\": 1800.0}  # this is the default\n)","key":"wgN2CH6AvG"},{"type":"outputs","id":"03L7ASypRjdfzYIGyYgx0","children":[{"type":"output","jupyter_data":{"ename":"ValueError","evalue":"Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.","output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mValueError\u001b[39m                                Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[31]\u001b[39m\u001b[32m, line 1\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m1\u001b[39m child_grid = \u001b[43mChildGrid\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      2\u001b[39m \u001b[43m    \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mchild_grid_parameters\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      3\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m=\u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      4\u001b[39m \u001b[43m    \u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\n\u001b[32m      5\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43msouth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      6\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43meast\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      7\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mnorth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      8\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mwest\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      9\u001b[39m \u001b[43m    \u001b[49m\u001b[43m}\u001b[49m\u001b[43m,\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     10\u001b[39m \u001b[43m    \u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mchild\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[32;43m1800.0\u001b[39;49m\u001b[43m}\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     11\u001b[39m \u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m<string>:20\u001b[39m, in \u001b[36m__init__\u001b[39m\u001b[34m(self, nx, ny, size_x, size_y, center_lon, center_lat, rot, N, theta_s, theta_b, hc, topography_source, hmin, verbose, parent_grid, boundaries, metadata)\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:80\u001b[39m, in \u001b[36mChildGrid.__post_init__\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     78\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m__post_init__\u001b[39m(\u001b[38;5;28mself\u001b[39m):\n\u001b[32m     79\u001b[39m     \u001b[38;5;28msuper\u001b[39m().__post_init__()\n\u001b[32m---> \u001b[39m\u001b[32m80\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_map_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     81\u001b[39m     \u001b[38;5;28mself\u001b[39m._modify_child_topography_and_mask()\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:89\u001b[39m, in \u001b[36mChildGrid._map_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     86\u001b[39m parent_grid_ds, child_grid_ds = \u001b[38;5;28mself\u001b[39m._prepare_grid_datasets()\n\u001b[32m     88\u001b[39m \u001b[38;5;66;03m# Map child boundaries onto parent grid indices\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m89\u001b[39m ds_nesting = \u001b[43mmap_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m     90\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     91\u001b[39m \u001b[43m    \u001b[49m\u001b[43mchild_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     92\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     93\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     94\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     95\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     97\u001b[39m \u001b[38;5;28mself\u001b[39m.ds_nesting = ds_nesting\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:369\u001b[39m, in \u001b[36mmap_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(parent_grid_ds, child_grid_ds, boundaries, prefix, period, update_land_indices)\u001b[39m\n\u001b[32m    363\u001b[39m lat_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mlatitude\u001b[39m\u001b[33m\"\u001b[39m]].isel(\n\u001b[32m    364\u001b[39m     **bdry_coords[direction]\n\u001b[32m    365\u001b[39m )\n\u001b[32m    367\u001b[39m mask_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mmask\u001b[39m\u001b[33m\"\u001b[39m]].isel(**bdry_coords[direction])\n\u001b[32m--> \u001b[39m\u001b[32m369\u001b[39m i_eta, i_xi = \u001b[43minterpolate_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    370\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlon_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlat_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmask_child\u001b[49m\n\u001b[32m    371\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    373\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m update_land_indices:\n\u001b[32m    374\u001b[39m     i_eta, i_xi = update_indices_if_on_parent_land(\n\u001b[32m    375\u001b[39m         i_eta, i_xi, grid_location, parent_grid_ds\n\u001b[32m    376\u001b[39m     )\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:472\u001b[39m, in \u001b[36minterpolate_indices\u001b[39m\u001b[34m(parent_grid_ds, lon, lat, mask)\u001b[39m\n\u001b[32m    470\u001b[39m \u001b[38;5;66;03m# Check for NaN values\u001b[39;00m\n\u001b[32m    471\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m np.sum(np.isnan(i)) > \u001b[32m0\u001b[39m \u001b[38;5;129;01mor\u001b[39;00m np.sum(np.isnan(j)) > \u001b[32m0\u001b[39m:\n\u001b[32m--> \u001b[39m\u001b[32m472\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\n\u001b[32m    473\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33mSome points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m    474\u001b[39m     )\n\u001b[32m    476\u001b[39m \u001b[38;5;66;03m# Check whether indices are close to border of parent grid\u001b[39;00m\n\u001b[32m    477\u001b[39m nxp, nyp = lon_parent.shape\n\n\u001b[31mValueError\u001b[39m: Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid."},"children":[],"key":"q2jz8PagIi"}],"key":"lozxfUtdI0"}],"key":"g5mWxiFY2y"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.plot_nesting(with_dim_names=True)","key":"KbvQkz8Vqh"},{"type":"outputs","id":"_PJszjuI01rkM53G75SSN","children":[],"key":"SCKrlLOX6e"}],"key":"KzbRRs0yqc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+child_name+\"_grid.nc\"\nchild_grid.save(filepath=filepath)","key":"VR9OFKFzNf"},{"type":"outputs","id":"tIa9nCwfIqQTShZZfmOOr","children":[],"key":"YsON0UD0dW"}],"key":"iMfNgWsSbP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath_nesting = project+child_name+\"_edata.nc\"","key":"zLzMg3oIBI"},{"type":"outputs","id":"jA6Ts0wMMSrP15KJJA_57","children":[],"key":"up6jxvxgt4"}],"key":"uhFm6esGdt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.save_nesting(filepath=filepath_nesting)","key":"jbEEvZlJzv"},{"type":"outputs","id":"mnFp3KGzsKlj30o9T4gyr","children":[],"key":"rTnFxU4NbU"}],"key":"GqBuSllCQW"}],"key":"YNyQFFPg6G"},"references":{"cite":{"order":[],"data":{}}}}