{"version":3,"kind":"Notebook","sha256":"264fb7f14f77e5e170acb6c5b3021b8cadc156af5c40eb39c5631607b6e812c8","slug":"setup-iceland1-marbl-2024-copy1","location":"/SETUP_Iceland1_MARBL_2024-Copy1.ipynb","dependencies":[],"frontmatter":{"title":"ROMS-TOOLS setup for Iceland1_MARBL_2024","content_includes_title":false,"kernelspec":{"name":"roms-tools","display_name":"Python (My roms-tools Kernel)","language":"python"},"exports":[{"format":"ipynb","filename":"SETUP_Iceland1_MARBL_2024-Copy1.ipynb","url":"/SETUP_Iceland1_MARBL-a286367c3b68a5c64f6116ab2a5d060b.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"First step is to set up the outer grid using ROMS-TOOLS and save the grid file.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RlIx8YqwDb"}],"key":"gxVLSaAK26"}],"key":"gcxAn8ex7R"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid","key":"U9qXKdIE5H"},{"type":"outputs","id":"ib7WPGuxjAMrp76-or73h","children":[],"key":"yscrG8A7dR"}],"key":"tFQkv8yKrX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"project='/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/'\ndatasets='/anvil/projects/x-ees250129/Datasets_subset/'\nmodel_name='Iceland1'\nchild_name='Iceland2'\ngrid_path='/anvil/projects/x-ees250129/x-uheede/MATLAB/setup_r2r_phys+bgc/1.Make_grid/Iceland1_grid_MAT1.nc'","key":"S23rcnwEQC"},{"type":"outputs","id":"i2EmX-4lLhFlymUUTXau9","children":[],"key":"tb7iCOu26i"}],"key":"wU4NqbViq7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=512,\n#    size_x=384,\n#    size_y=384,\n#    center_lon=-24,\n#    center_lat=64.9,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"KOqSew65Es"},{"type":"outputs","id":"_Aly8yzwH6-SuFtHCpaV-","children":[],"key":"amvvCBsNyw"}],"key":"EvexJC7loc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#%%time\n\n#grid = Grid(\n#    nx=512,\n#    ny=384,\n#    size_x=384,\n#    size_y=288,\n#    center_lon=-22.6,\n#    center_lat=63.55,\n#    rot=0,\n#    topography_source={\n#        \"name\": \"SRTM15\",\n#        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n#    N=60  # number of vertical layers\n#)","key":"Ck5TgPnDWx"},{"type":"outputs","id":"NrPhJ52tAn-MNIUxaaGTT","children":[],"key":"kXnUCtXQhK"}],"key":"FDJlChrQRS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid = Grid.from_file(grid_path)","key":"AtYXlgWC5v"},{"type":"outputs","id":"KPt_ne82bd-HYPLpS7TF6","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-11-18 18:34:40 - WARNING - Vertical coordinates (Cs_r, Cs_w) not found in grid file.\n2025-11-18 18:34:40 - INFO - === Preparing the vertical coordinate system using N = 100, theta_s = 5.0, theta_b = 2.0, hc = 300.0 ===\n2025-11-18 18:34:40 - INFO - Total time: 0.003 seconds\n2025-11-18 18:34:40 - INFO - ========================================================================================================\n"},"children":[],"key":"EDkZLyWkT0"}],"key":"gUXasyVzei"}],"key":"TpHGmlMoCk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.update_vertical_coordinate(N=60, theta_s=5.0, theta_b=2.0, hc=300.0, verbose=False)","key":"t0t7bCzrJe"},{"type":"outputs","id":"gbdHTeyS0FW17Cca-9hGS","children":[],"key":"f2RyYsFqrr"}],"key":"vI70vu6kJk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.plot()","key":"iOQYcGa5g4"},{"type":"outputs","id":"SddzCafE-ul0aWtJrwwBN","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"70240b2ddedc41c2506ea18b24900928","path":"/70240b2ddedc41c2506ea18b24900928.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"GmxXHKsHa7"}],"key":"AMLoOL38wg"}],"key":"wdnmhjLo3A"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+'_grid.nc'\nyaml_filepath=project+model_name+'_grid_60.yaml'","key":"tvwatuNqMa"},{"type":"outputs","id":"YJdTdtengapMip6zKpu7v","children":[],"key":"Px4CLMpW3e"}],"key":"A2Js7canwK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"yaml_filepath","key":"YU2ZawDVF3"},{"type":"outputs","id":"STJL4t6SiMX6NhKNkJNsE","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/plain":{"content":"'/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid_60.yaml'","content_type":"text/plain"}}},"children":[],"key":"jL8Engd5iT"}],"key":"ZcOkZK8tEY"}],"key":"txuEtH8fmk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.save(filepath)","key":"IFqvjNplWY"},{"type":"outputs","id":"iAJb7TfnDixVYE8Xy7As4","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:54:08 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc\n"},"children":[],"key":"JnsYNIc41Z"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":12,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_grid.nc')]","content_type":"text/plain"}}},"children":[],"key":"UUie2Q4tQ5"}],"key":"KlhouxZF77"}],"key":"WMDXpOCwdO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"grid.to_yaml(yaml_filepath)","key":"jkHREEHaON"},{"type":"outputs","id":"RGQoGEJUwRie8516axqNI","children":[],"key":"BGJZ0ocTUL"}],"key":"wvqUXFC0oJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"tpxo_path = datasets+\"TPXO/TPXO10.v2/\"\ntpxo_dict = {\n    \"grid\": tpxo_path + \"grid_tpxo10v2.nc\",\n    \"h\": tpxo_path + \"h_tpxo10.v2.nc\",\n    \"u\": tpxo_path + \"u_tpxo10.v2.nc\",\n}","key":"t8Igw2MT9u"},{"type":"outputs","id":"_mqstkCRvIJtx3uzmrOk-","children":[],"key":"oNtEs89Wx5"}],"key":"Guuw6Mf22L"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next, we set up tidal forcing:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"P2fp6HNDxL"}],"key":"Z0Kld4HaO4"}],"key":"NKqPKH4Z9Z"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import TidalForcing","key":"PRxL0cnlCH"},{"type":"outputs","id":"lAtVVINrV_W1-Po4rdIOe","children":[],"key":"b4c5ze8SXK"}],"key":"y6zcbqTtpb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from datetime import datetime","key":"toqO45ecty"},{"type":"outputs","id":"w5BHGlGDkvD4j3dt8A6J2","children":[],"key":"sLlLu05QeV"}],"key":"fZCyx4TMzA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model_reference_date = datetime(2000, 1, 1)","key":"p7sAEaYwow"},{"type":"outputs","id":"AQsJmyLh0k8my3fEPzAJC","children":[],"key":"wt1MoiBlBb"}],"key":"NVpaCCxAi3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\ntidal_forcing = TidalForcing(\n    grid=grid,\n    source={\"name\": \"TPXO\", \"path\": tpxo_dict},\n    ntides=15,  # Number of constituents to consider <= 15. Default is 10.\n    model_reference_date=model_reference_date,  # Model reference date. Default is January 1, 2000.\n    use_dask=True\n)","key":"gyMchtMJ1Z"},{"type":"outputs","id":"ue272zthQKEQEy0SO_IWb","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:37 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:02:38 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"nwonUWX0ql"}],"key":"plSLrSaBpU"}],"key":"KAtxd3Z9bZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_tides.nc\"","key":"NqNLPnw8sy"},{"type":"outputs","id":"Gn-keO5sujUxKXxvrSBoA","children":[],"key":"oXkQgb68Q7"}],"key":"BrIJm3qUWx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time tidal_forcing.save(filepath)","key":"O8JTO61HGf"},{"type":"outputs","id":"I0pKRn5gmeNZr-45RxdnZ","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:38 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc\n"},"children":[],"key":"freMh5QWAq"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 6.04 sms\nCPU times: user 2.87 s, sys: 1.11 s, total: 3.98 s\nWall time: 6.23 s\n"},"children":[],"key":"xa92uy2AKk"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":16,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_tides.nc')]","content_type":"text/plain"}}},"children":[],"key":"NM7FjVkkTO"}],"key":"M88kYkmLKW"}],"key":"ksMxBgvZqf"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For the surface forcing, we use ERA5 plus the unified BGC dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ELckM3COoP"}],"key":"UroevdPqlc"}],"key":"ANohIT8XWU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, SurfaceForcing","key":"ERXZ5yhpXh"},{"type":"outputs","id":"zv32JM7p6rlb5hCxE8twU","children":[],"key":"CLGTiStze2"}],"key":"X8A5u448al"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time = datetime(2023, 12, 1)\nend_time = datetime(2024, 6, 30)","key":"LPd6nqHEbj"},{"type":"outputs","id":"UX2RVhRvmiRaYZrJsFM2b","children":[],"key":"P27e5LO4Hf"}],"key":"RHeiMdAfka"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"start_time1 = datetime(2024, 6, 1)\nend_time1 = datetime(2024, 12, 1)","key":"WP6T4Fa3Bv"},{"type":"outputs","id":"Od6xxgwBNGOcNVRhV_hdj","children":[],"key":"VwlwBdKnbf"}],"key":"drlyeNuru2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs = {\n    \"grid\": grid,\n    \"start_time\": start_time,\n    \"end_time\": end_time,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"pAjy2Ohtyy"},{"type":"outputs","id":"D3Gs3J0Iwo5SeFrlTHkZ2","children":[],"key":"KBJujSgT1A"}],"key":"mZL91JaT8u"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing_kwargs1 = {\n    \"grid\": grid,\n    \"start_time\": start_time1,\n    \"end_time\": end_time1,\n    \"type\": \"physics\",\n    \"model_reference_date\": datetime(2000, 1, 1), # this is the default\n}","key":"Mw1FHaU19d"},{"type":"outputs","id":"DeGLH4DY6EJ_OXXnXBv-O","children":[],"key":"KrStqPEOga"}],"key":"RrxTkgNfMB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing = SurfaceForcing(\n    **surface_forcing_kwargs,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"c8YK9UoQDf"},{"type":"outputs","id":"ufOrKul0q-QQVHLcmhTcN","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:02:45 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-27 13:04:30 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-27 13:04:30 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-27 13:04:33 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"PthkduI8kj"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 49s, sys: 7.95 s, total: 2min 57s\nWall time: 3min\n"},"children":[],"key":"C2CJGeJ9xE"}],"key":"iWrTvUV3XS"}],"key":"WlTQfVS01p"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nsurface_forcing1 = SurfaceForcing(\n    **surface_forcing_kwargs1,\n    source={\"name\": \"ERA5\"},\n    use_dask=True,\n)","key":"K0TAjspXwo"},{"type":"outputs","id":"Ra0d9nOZd1boDc3PUptm0","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:55:31 - INFO - No path specified for ERA5 source; defaulting to ARCO ERA5 dataset on Google Cloud.\n2025-10-29 17:57:16 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bulk_frc.opt` ROMS option file.\n2025-10-29 17:57:17 - INFO - Applying 2D horizontal fill to the source data before regridding.\n2025-10-29 17:57:20 - INFO - Applying 2D horizontal fill to the source data before regridding.\n"},"children":[],"key":"ykLA1BPm4g"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 2min 34s, sys: 12.6 s, total: 2min 46s\nWall time: 2min 50s\n"},"children":[],"key":"vj1kv3NWhd"}],"key":"BvmtaVrGYN"}],"key":"oV3xHXIMcV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"surface_forcing.plot(\"uwnd\", time=0)","key":"VnmYyD3KdK"},{"type":"outputs","id":"rQ7-27vDoTEiqIB1O4xdp","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 101.99 ms\n"},"children":[],"key":"SUNnkV8dhP"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"9eb29aed7373f4422cd751ded65ff4c4","path":"/9eb29aed7373f4422cd751ded65ff4c4.png"},"text/plain":{"content":"<Figure size 1300x700 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"K6bV0qIx6p"}],"key":"IVc4zVwlMA"}],"key":"BNWq41Cz30"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"#cesm_bgc_path = \"/global/cfs/projectdirs/m4746/Datasets/CESM_REGRIDDED/CESM-surface_lowres_regridded.nc\"\nunified_bgc_path = datasets+\"UNIFIED/BGCdataset.nc\"","key":"y3RoiYmllK"},{"type":"outputs","id":"5Bm2FaY-oodKBr913K3xZ","children":[],"key":"uWQbJ0wL8v"}],"key":"IGwEUw4nzc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n\nunified_bgc_surface_forcing = SurfaceForcing(\n    grid=grid,\n    start_time=start_time,\n    end_time=end_time,\n    source={\"name\": \"UNIFIED\", \"path\": unified_bgc_path, \"climatology\": True},\n    type=\"bgc\",\n    use_dask=True,\n)","key":"vFchHOARkg"},{"type":"outputs","id":"YJdwqkV6CIYrLLkY8Vcdh","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:48 - INFO - Data will be interpolated onto the grid coarsened by factor 2. Remember to set `interp_frc = 1` in your `bgc.opt` ROMS option file.\n2025-10-27 13:05:48 - INFO - 2D horizontal fill is skipped because source data already contains filled values.\n"},"children":[],"key":"dRWfb4SCGF"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"CPU times: user 145 ms, sys: 8.95 ms, total: 154 ms\nWall time: 299 ms\n"},"children":[],"key":"psjM7wFHKe"}],"key":"avQG0w7Mpe"}],"key":"XKyXPtjfJE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_surface_forcing2024.nc\"","key":"eELia712x9"},{"type":"outputs","id":"nJgr6gU15FufFurf6IO26","children":[],"key":"WU8L5LHIzy"}],"key":"Eahfl06m77"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing.save(filepath, group=True)","key":"EZJWHdPiba"},{"type":"outputs","id":"Sl6-z6YY1ilQzBfGQBe7f","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:05:53 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n"},"children":[],"key":"Pc6SCILpJu"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 77.22 s\n[########################################] | 100% Completed | 79.04 s\n[########################################] | 100% Completed | 74.84 s\n[########################################] | 100% Completed | 79.05 s\n[########################################] | 100% Completed | 77.91 s\n[########################################] | 100% Completed | 80.71 s\n[########################################] | 100% Completed | 77.10 s\nCPU times: user 15min 33s, sys: 2min 11s, total: 17min 44s\nWall time: 10min 47s\n"},"children":[],"key":"zVQYPlA69U"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":25,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202312.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202401.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202402.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202403.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202404.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202405.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc')]","content_type":"text/plain"}}},"children":[],"key":"lGoCfaQOE4"}],"key":"UpXCpum8h3"}],"key":"a2HeTEcAb6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time surface_forcing1.save(filepath, group=True)","key":"hAfZLmNj1H"},{"type":"outputs","id":"U_jUKqcUigJ5chEeYndZ9","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-29 17:58:23 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc\n"},"children":[],"key":"EFCmwlJVni"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 73.88 s\n[########################################] | 100% Completed | 76.59 s\n[########################################] | 100% Completed | 77.23 s\n[########################################] | 100% Completed | 76.66 s\n[########################################] | 100% Completed | 75.70 s\n[########################################] | 100% Completed | 74.32 s\n[########################################] | 100% Completed | 409.54 ms\nCPU times: user 12min 45s, sys: 2min, total: 14min 45s\nWall time: 9min 6s\n"},"children":[],"key":"mjrXSenEoA"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":19,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202406.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202407.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202408.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202409.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202410.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202411.nc'),\n PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_surface_forcing2024_202412.nc')]","content_type":"text/plain"}}},"children":[],"key":"NdWBnadp2z"}],"key":"UMjclBP9Ne"}],"key":"bNHUiRKbha"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+model_name+\"_bgc_surface_forcing.nc\"","key":"zzIrhF21Pm"},{"type":"outputs","id":"D6Y1fcPqEr4bBbklU-c0N","children":[],"key":"xuxexgp23E"}],"key":"FMoEinWElP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%time unified_bgc_surface_forcing.save(filepath)","key":"HQSuhV5fQd"},{"type":"outputs","id":"IS0QPs3vD_2_XWWBrzSCA","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"2025-10-27 13:16:36 - INFO - Writing the following NetCDF files:\n/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc\n"},"children":[],"key":"Gh9qVysZGs"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"[########################################] | 100% Completed | 206.46 ms\nCPU times: user 161 ms, sys: 15 ms, total: 176 ms\nWall time: 310 ms\n"},"children":[],"key":"V00oBIwc1C"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":27,"metadata":{},"data":{"text/plain":{"content":"[PosixPath('/anvil/projects/x-ees250129/x-uheede/INPUT_files/Iceland1_MARBL_2024/Iceland1_bgc_surface_forcing_clim.nc')]","content_type":"text/plain"}}},"children":[],"key":"nW5q2JXcO2"}],"key":"hU0h0JRv8P"}],"key":"EtACvKPIgI"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next we generate the initial file","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"j7VqKD2tWR"}],"key":"zH5EuHfPMA"}],"key":"fsxvm4lqbX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from roms_tools import Grid, ChildGrid","key":"JFhOvg2ZTU"},{"type":"outputs","id":"r94dVMdsakh8YurHAqdjf","children":[],"key":"XKMeNBeIQQ"}],"key":"NjsUFv8QaA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"parent_grid = grid","key":"Rqs2OlXHc4"},{"type":"outputs","id":"34CkPKE64oh_t_LK3gQ4N","children":[],"key":"Cbf9Rhc5Ti"}],"key":"zKgNMQOvE3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid_parameters = {\n    \"nx\": 512,\n    \"ny\": 512,\n    \"size_x\": 102.4,\n    \"size_y\": 102.4,\n    \"center_lon\": -22.4,\n    \"center_lat\": 64.39,\n    \"rot\": 0,\n    \"topography_source\": {\n        \"name\": \"SRTM15\",\n        \"path\": datasets+\"SRTM15/SRTM15_V2.6.nc\"},\n    \"N\":40  # number of vertical layers\n}","key":"XQjy9zbhE5"},{"type":"outputs","id":"akydREF5LEOvdntjlS8tC","children":[],"key":"uuiXcgPnkn"}],"key":"ezZqQ4woi8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid = ChildGrid(\n    **child_grid_parameters,\n    parent_grid=parent_grid,\n    boundaries={\n        \"south\": True,\n        \"east\": False,\n        \"north\": False,\n        \"west\": True,\n    },  # this is the default\n    metadata={\"prefix\": \"child\", \"period\": 1800.0}  # this is the default\n)","key":"KzSnfbbLcr"},{"type":"outputs","id":"Wd_x_v75_SErLrTY7FN9u","children":[{"type":"output","jupyter_data":{"ename":"ValueError","evalue":"Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.","output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mValueError\u001b[39m                                Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[31]\u001b[39m\u001b[32m, line 1\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m1\u001b[39m child_grid = \u001b[43mChildGrid\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      2\u001b[39m \u001b[43m    \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mchild_grid_parameters\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      3\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m=\u001b[49m\u001b[43mparent_grid\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      4\u001b[39m \u001b[43m    \u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\n\u001b[32m      5\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43msouth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      6\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43meast\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      7\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mnorth\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      8\u001b[39m \u001b[43m        \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mwest\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m      9\u001b[39m \u001b[43m    \u001b[49m\u001b[43m}\u001b[49m\u001b[43m,\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     10\u001b[39m \u001b[43m    \u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m=\u001b[49m\u001b[43m{\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mchild\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[32;43m1800.0\u001b[39;49m\u001b[43m}\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# this is the default\u001b[39;49;00m\n\u001b[32m     11\u001b[39m \u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m<string>:20\u001b[39m, in \u001b[36m__init__\u001b[39m\u001b[34m(self, nx, ny, size_x, size_y, center_lon, center_lat, rot, N, theta_s, theta_b, hc, topography_source, hmin, verbose, parent_grid, boundaries, metadata)\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:80\u001b[39m, in \u001b[36mChildGrid.__post_init__\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     78\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m__post_init__\u001b[39m(\u001b[38;5;28mself\u001b[39m):\n\u001b[32m     79\u001b[39m     \u001b[38;5;28msuper\u001b[39m().__post_init__()\n\u001b[32m---> \u001b[39m\u001b[32m80\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_map_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     81\u001b[39m     \u001b[38;5;28mself\u001b[39m._modify_child_topography_and_mask()\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:89\u001b[39m, in \u001b[36mChildGrid._map_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m     86\u001b[39m parent_grid_ds, child_grid_ds = \u001b[38;5;28mself\u001b[39m._prepare_grid_datasets()\n\u001b[32m     88\u001b[39m \u001b[38;5;66;03m# Map child boundaries onto parent grid indices\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m89\u001b[39m ds_nesting = \u001b[43mmap_child_boundaries_onto_parent_grid_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m     90\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     91\u001b[39m \u001b[43m    \u001b[49m\u001b[43mchild_grid_ds\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     92\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mboundaries\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     93\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mprefix\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     94\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmetadata\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mperiod\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m     95\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     97\u001b[39m \u001b[38;5;28mself\u001b[39m.ds_nesting = ds_nesting\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:369\u001b[39m, in \u001b[36mmap_child_boundaries_onto_parent_grid_indices\u001b[39m\u001b[34m(parent_grid_ds, child_grid_ds, boundaries, prefix, period, update_land_indices)\u001b[39m\n\u001b[32m    363\u001b[39m lat_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mlatitude\u001b[39m\u001b[33m\"\u001b[39m]].isel(\n\u001b[32m    364\u001b[39m     **bdry_coords[direction]\n\u001b[32m    365\u001b[39m )\n\u001b[32m    367\u001b[39m mask_child = child_grid_ds[names[\u001b[33m\"\u001b[39m\u001b[33mmask\u001b[39m\u001b[33m\"\u001b[39m]].isel(**bdry_coords[direction])\n\u001b[32m--> \u001b[39m\u001b[32m369\u001b[39m i_eta, i_xi = \u001b[43minterpolate_indices\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    370\u001b[39m \u001b[43m    \u001b[49m\u001b[43mparent_grid_ds\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlon_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlat_child\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmask_child\u001b[49m\n\u001b[32m    371\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    373\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m update_land_indices:\n\u001b[32m    374\u001b[39m     i_eta, i_xi = update_indices_if_on_parent_land(\n\u001b[32m    375\u001b[39m         i_eta, i_xi, grid_location, parent_grid_ds\n\u001b[32m    376\u001b[39m     )\n\n\u001b[36mFile \u001b[39m\u001b[32m~/.conda/envs/roms_tools/lib/python3.12/site-packages/roms_tools/setup/nesting.py:472\u001b[39m, in \u001b[36minterpolate_indices\u001b[39m\u001b[34m(parent_grid_ds, lon, lat, mask)\u001b[39m\n\u001b[32m    470\u001b[39m \u001b[38;5;66;03m# Check for NaN values\u001b[39;00m\n\u001b[32m    471\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m np.sum(np.isnan(i)) > \u001b[32m0\u001b[39m \u001b[38;5;129;01mor\u001b[39;00m np.sum(np.isnan(j)) > \u001b[32m0\u001b[39m:\n\u001b[32m--> \u001b[39m\u001b[32m472\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\n\u001b[32m    473\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33mSome points are outside the grid. Please choose either a bigger parent grid or a smaller child grid.\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m    474\u001b[39m     )\n\u001b[32m    476\u001b[39m \u001b[38;5;66;03m# Check whether indices are close to border of parent grid\u001b[39;00m\n\u001b[32m    477\u001b[39m nxp, nyp = lon_parent.shape\n\n\u001b[31mValueError\u001b[39m: Some points are outside the grid. Please choose either a bigger parent grid or a smaller child grid."},"children":[],"key":"So3dVtaaEF"}],"key":"ovuO1CrabQ"}],"key":"JmQFaKawzJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.plot_nesting(with_dim_names=True)","key":"S4wmbGOF62"},{"type":"outputs","id":"-WL_av8vKzN-PRiMuG10I","children":[],"key":"ijGWonZDQg"}],"key":"Zp0LxveQNC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath = project+child_name+\"_grid.nc\"\nchild_grid.save(filepath=filepath)","key":"I9xwGP2qXV"},{"type":"outputs","id":"lt4EfEVhEI7MxCTkQNLC9","children":[],"key":"o0yeVgROfY"}],"key":"SFntPhPZLC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"filepath_nesting = project+child_name+\"_edata.nc\"","key":"dD4UDZRiDI"},{"type":"outputs","id":"0s1rHKZn-1Ns3KureEGM7","children":[],"key":"NpBx9hBOxI"}],"key":"dE5r08Fozr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"child_grid.save_nesting(filepath=filepath_nesting)","key":"q2eR1D8IIl"},{"type":"outputs","id":"k18bccBOMKBLtcQOgHRGV","children":[],"key":"gQRfVsR2Ea"}],"key":"jmp31jsHpC"}],"key":"Y3Tfn6LxJ1"},"references":{"cite":{"order":[],"data":{}}}}